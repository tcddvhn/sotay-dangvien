<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>S·ªï tay nghi·ªáp v·ª• c√¥ng t√°c t·ªï ch·ª©c ƒë·∫£ng, ƒë·∫£ng vi√™n</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#cc0000">

    <style>
        /* CSS GIAO DI·ªÜN CH√çNH & KH·ªêI ACCORDION (Gi·ªØ nguy√™n giao di·ªán M·∫π b·ªìng con tuy·ªát ƒë·∫πp) */
        :root { --primary-color: #cc0000; --primary-dark: #a30000; --yellow-party: #f1c40f; --text-color: #333; --bg-sidebar: #2c3e50; --header-height: 50px; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Times New Roman', Times, serif; line-height: 1.6; color: var(--text-color); margin: 0; background-color: #f4f4f4; font-size: 1.1rem; }
        
        .sidebar { width: 280px; background-color: var(--bg-sidebar); color: white; padding: 20px; position: fixed; top: 0; bottom: 0; left: 0; overflow-y: auto; z-index: 1000; transition: transform 0.3s ease; box-shadow: 2px 0 5px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
        .sidebar h3 { border-bottom: 1px solid #555; padding-bottom: 15px; margin-top: 20px; text-transform: uppercase; font-size: 1.1rem; text-align: center; color: var(--yellow-party); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        .sidebar ul { list-style: none; padding: 0; flex: 1; }
        .sidebar li { margin-bottom: 5px; }
        .sidebar a { color: #ecf0f1; text-decoration: none; display: block; padding: 12px 15px; border-radius: 4px; transition: 0.2s; font-size: 1.05rem; cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .sidebar a:hover { background-color: var(--primary-color); padding-left: 20px; }
        .close-sidebar-btn { text-align: right; margin-bottom: 10px; display: none; }
        @media (max-width: 992px) { .sidebar { transform: translateX(-100%); width: 85%; max-width: 320px; } .sidebar.active { transform: translateX(0); } .close-sidebar-btn { display: block; } }
        
        .mobile-header { display: none; position: fixed; top: 0; left: 0; right: 0; height: var(--header-height); background: var(--primary-color); z-index: 990; align-items: center; padding: 0 15px; color: white; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.2); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        .menu-toggle-btn { background: none; border: none; color: white; font-size: 24px; cursor: pointer; margin-right: 15px; }
        @media (max-width: 992px) { .mobile-header { display: flex; } }
        .overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 999; display: none; backdrop-filter: blur(2px); }
        .overlay.active { display: block; }

        .main-content { font-family: 'Times New Roman', Times, serif; font-size: 1.15rem; padding: 20px 20px; background-color: white; min-height: 100vh; transition: margin-left 0.3s ease; }
        @media (min-width: 992px) { .main-content { margin-left: 280px; padding: 40px 60px; } }
        @media (max-width: 992px) { .main-content { padding-top: 70px; } }
        
        h1 { color: var(--primary-color); border-bottom: 3px solid var(--primary-color); padding-bottom: 15px; margin-top: 0; font-size: 1.6rem; text-transform: uppercase; line-height: 1.3; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        
        .phan-header { background-color: #fcebeb; padding: 15px; border-left: 6px solid var(--primary-color); margin-top: 30px; color: var(--primary-dark); font-size: 1.3em; font-weight: bold; }
        .muc-header { color: #b71c1c; margin-top: 25px; margin-bottom: 15px; font-weight: 700; font-size: 1.15em; }

        .step-box { background: #fff; border: 1px solid #e0e0e0; border-radius: 8px; margin-bottom: 10px; margin-top: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.04); position: relative; scroll-margin-top: 70px; }
        .step-box.level-2 { border-left: 5px solid #2980b9; } 
        .step-box.level-3 { border-left: 4px solid #27ae60; } 
        .step-box.level-4 { border-left: 3px solid var(--primary-color); } 

        .step-header { padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; background: #fff; border-radius: 8px; transition: background 0.2s; }
        .step-header:hover { background: #f9f9f9; }
        .step-title-wrapper { flex: 1; padding-right: 15px; }
        .step-icon { color: #888; transition: transform 0.3s ease; font-size: 0.85rem; font-family: -apple-system, sans-serif;}

        .step-body-wrapper { display: grid; grid-template-rows: 0fr; transition: grid-template-rows 0.35s ease; }
        .step-box.active > .step-body-wrapper { grid-template-rows: 1fr; }
        .step-body { overflow: hidden; }
        .step-body-inner { padding: 0 15px 0 15px; }
        .step-box.active > .step-body-wrapper > .step-body > .step-body-inner { padding-top: 15px; padding-bottom: 15px; border-top: 1px dashed #eee; }
        .step-box.active > .step-header .step-icon { transform: rotate(180deg); color: var(--primary-color); }

        .step-number { background: var(--primary-color); color: white; padding: 4px 12px; border-radius: 20px; font-weight: bold; display: inline-block; font-size: 0.9rem; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;}
        .tag-label { font-size: 0.75rem; text-transform: uppercase; color: #666; font-weight: bold; margin-bottom: 6px; display: block; letter-spacing: 0.5px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;}
        
        .step-actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px;}
        .btn-trich-dan { display: inline-flex; align-items: center; background-color: #e3f2fd; color: #0d47a1; padding: 8px 12px; border-radius: 6px; border: 1px solid #90caf9; font-size: 0.9em; cursor: pointer; font-weight: 600; justify-content: center; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;}
        .inline-download { display: inline-flex; align-items: center; justify-content: center; background-color: #e8f5e9; color: #2e7d32; padding: 4px 10px; border-radius: 12px; border: 1px solid #a5d6a7; font-size: 0.85rem; font-weight: bold; text-decoration: none; margin-left: 10px; vertical-align: middle; white-space: nowrap; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; box-shadow: 0 1px 2px rgba(0,0,0,0.05); transition: 0.2s; }
        @media (max-width: 768px) { .btn-trich-dan { width: 100%; } }

        #backToTop { display: none; position: fixed; bottom: 20px; right: 20px; z-index: 90; border: none; background-color: var(--primary-color); color: white; cursor: pointer; padding: 12px 15px; border-radius: 50%; box-shadow: 0 4px 10px rgba(0,0,0,0.3); font-size: 1.2rem; }
        #btnSearchFab { position: fixed; bottom: 20px; left: 20px; z-index: 90; border: none; background-color: var(--yellow-party); color: var(--primary-dark); cursor: pointer; padding: 12px 15px; border-radius: 50%; box-shadow: 0 4px 10px rgba(0,0,0,0.3); font-size: 1.4rem; transition: 0.3s; display: flex; align-items: center; justify-content: center;}
        @media (min-width: 992px) { #btnSearchFab { left: 300px; } }

        /* MODAL POPUP CHUNG */
        .modal-user { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); padding: 10px; align-items: center; justify-content: center; }
        .modal-user-content { background-color: #fefefe; width: 100%; max-width: 700px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); display: flex; flex-direction: column; max-height: 85vh; animation: slideUp 0.3s; }
        .modal-user-header { background-color: var(--primary-color); color: white; padding: 15px; border-radius: 12px 12px 0 0; font-weight: bold; display: flex; justify-content: space-between; align-items: center; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;}
        .modal-user-body { font-family: 'Times New Roman', Times, serif; padding: 25px; line-height: 1.6; overflow-y: auto; text-align: justify; font-size: 1.15rem; }
        @keyframes slideUp { from {transform: translateY(20px); opacity: 0;} to {transform: translateY(0); opacity: 1;} }

        /* CSS TR·ª¢ L√ù T√åM KI·∫æM */
        .search-container { padding: 20px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; display: flex; flex-direction: column; flex: 1; overflow: hidden;}
        .search-input-wrapper { display: flex; border: 2px solid var(--primary-color); border-radius: 8px; overflow: hidden; margin-bottom: 15px; flex-shrink: 0;}
        .search-input-wrapper input { flex: 1; padding: 12px 15px; border: none; font-size: 1rem; outline: none;}
        .search-input-wrapper button { background: var(--primary-color); color: white; border: none; padding: 0 20px; font-weight: bold; cursor: pointer;}
        .faq-suggestions { padding-bottom: 15px; border-bottom: 1px solid #eee; margin-bottom: 10px; flex-shrink: 0;}
        .faq-suggestions p { margin: 0 0 10px 0; font-size: 0.95rem; color: #555; font-weight: bold; }
        .faq-chips { display: flex; flex-wrap: wrap; gap: 8px; }
        .faq-chip { background: #f0f2f5; border: 1px solid #ddd; padding: 8px 15px; border-radius: 20px; font-size: 0.9rem; color: #333; cursor: pointer; transition: 0.2s; }
        #searchResults { overflow-y: auto; flex: 1; font-family: 'Times New Roman', Times, serif;}
        .result-item { padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; transition: 0.2s;}
        .result-path { font-size: 0.85rem; color: #7f8c8d; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; margin-bottom: 5px;}
        .result-title { font-weight: bold; color: var(--primary-dark); font-size: 1.1rem; margin-bottom: 5px;}
        .result-snippet { font-size: 0.95rem; color: #555; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;}
        .no-result { text-align: center; color: #999; padding: 20px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;}

        /* CSS QU·∫¢N TR·ªä M·ªöI */
        #loginOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 6000; align-items: center; justify-content: center; overflow: hidden; background-color: #8c0000; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
        .trong-dong-bg { position: absolute; width: 100%; height: 100%; top: 0; left: 0; z-index: -1; background-image: linear-gradient(rgba(0,0,0,0.4), rgba(0,0,0,0.4)), url('img_5-hinh-nen-powerpoint-trong-dong.jpg'); background-size: cover; background-position: center; background-repeat: no-repeat; }
        .login-card { background: rgba(255, 255, 255, 0.98); width: 90%; max-width: 400px; padding: 40px 30px; border-radius: 20px; box-shadow: 0 15px 35px rgba(0,0,0,0.5); position: relative; animation: zoomIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes zoomIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .close-login { position: absolute; top: 15px; right: 20px; font-size: 24px; color: #999; cursor: pointer; transition: 0.2s; }
        .login-header { text-align: center; margin-bottom: 25px; }
        .party-logo img { width: 110px; height: auto; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.2)); }
        .login-header h2 { margin: 0; color: var(--primary-dark); font-size: 1.5rem; text-transform: uppercase; }
        .input-group { display: flex; align-items: center; background: #f0f2f5; border: 1px solid #e4e6eb; border-radius: 10px; margin-bottom: 20px; padding: 5px 15px; transition: 0.3s; }
        .input-icon { color: #888; font-size: 18px; margin-right: 10px; }
        .input-group input { border: none; background: transparent; padding: 12px 0; width: 100%; font-size: 16px; outline: none; }
        .login-error { color: #dc3545; font-size: 0.9rem; text-align: center; margin-top: -10px; margin-bottom: 15px; display: none; }
        .btn-login { width: 100%; background: linear-gradient(135deg, #cc0000, #a30000); color: white; border: none; padding: 15px; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; text-transform: uppercase; box-shadow: 0 4px 10px rgba(204,0,0,0.3); }

        #adminPanel { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 5000; overflow-y: auto; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;}
        .admin-layout { display: flex; height: 100%; flex-direction: column; }
        @media (min-width: 768px) { .admin-layout { flex-direction: row; } }
        .admin-sidebar { background: #f8f9fa; border-bottom: 1px solid #ddd; padding: 10px; height: 40vh; display: flex; flex-direction: column; }
        @media (min-width: 768px) { .admin-sidebar { width: 350px; height: 100vh; border-right: 1px solid #ddd; border-bottom: none; } }
        .admin-main { flex: 1; padding: 20px; overflow-y: auto; background: #fff; height: 60vh; position: relative;}
        @media (min-width: 768px) { .admin-main { height: 100vh; } }
        .tree-container { flex: 1; overflow-y: auto; border: 1px solid #ddd; background: #fff; border-radius: 6px; padding: 10px; font-family: 'Times New Roman', Times, serif; font-size: 1.15rem; box-shadow: inset 0 2px 4px rgba(0,0,0,0.02);}
        .tree-node { margin-bottom: 2px; }
        .tree-item { padding: 8px 10px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; transition: all 0.2s ease; border: 1px solid transparent; color: #444; }
        .tree-item.active { background: #e3f2fd; color: #0d47a1; font-weight: bold; border-left: 4px solid #007bff; }
        .root-item { font-weight: bold; background: #f8f9fa; border: 1px solid #eee; margin-top: 5px; color: var(--primary-dark); }
        .sub-item { position: relative; font-size: 1.05rem; }
        .sub-item::before { content: ""; position: absolute; left: -12px; top: 50%; width: 10px; border-top: 1px dashed #aaa; }
        .tree-children { margin-left: 12px; border-left: 1px dashed #aaa; padding-left: 12px; margin-top: 2px; }
        
        .form-control { font-family: 'Times New Roman', Times, serif; font-size: 1.15rem; width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 6px; margin-bottom: 15px; outline: none;}
        .form-control:focus { border-color: #007bff; box-shadow: 0 0 5px rgba(0,123,255,0.25); }
        .btn { padding: 12px 20px; border: none; border-radius: 6px; font-weight: bold; color: white; cursor: pointer; margin-bottom: 10px; font-family: -apple-system, sans-serif;}
        .btn-save { background: #28a745; width: 100%; font-size: 1.1rem; padding: 15px;} .btn-save:hover{ background: #218838; }
        .btn-close { background: #6c757d; } .btn-delete { background: #dc3545; } .btn-add { background: #007bff; }
        .admin-trigger { margin-top: 20px; text-align: center; padding: 15px; border-top: 1px solid #444; background: rgba(0,0,0,0.1); cursor: pointer; color: #bdc3c7;}
    </style>
</head>
<body>

    <div class="mobile-header">
        <button class="menu-toggle-btn" onclick="toggleMenu()">‚ò∞</button>
        <span>S·ªî TAY ƒê·∫¢NG VI√äN</span>
    </div>

    <div class="overlay" onclick="toggleMenu(false)"></div>
    
    <div class="sidebar" id="sidebar">
        <div class="close-sidebar-btn"><span onclick="toggleMenu(false)" style="cursor:pointer; color:#fff; font-size:1.5rem; padding: 10px;">‚úï</span></div>
        <h3 style="margin-top:0">M·ª§C L·ª§C</h3>
        <ul id="menuList"></ul>
        <div style="margin-top: auto;"></div>
        <div class="admin-trigger" onclick="openLoginForm()">‚öôÔ∏è ƒêƒÉng nh·∫≠p Qu·∫£n tr·ªã</div>
    </div>

    <div class="main-content">
        <h1>NGHI·ªÜP V·ª§ C√îNG T√ÅC T·ªî CH·ª®C ƒê·∫¢NG</h1>
        <div id="dynamicContent"></div>
        <br><br><br>
    </div>

    <button id="btnSearchFab" onclick="openSearchModal()" title="T√¨m ki·∫øm">üîç</button>
    <button id="backToTop" onclick="topFunction()">‚¨Ü</button>

    <div id="modalSearch" class="modal-user" onclick="closeModalOnBgClick(event, 'modalSearch')">
        <div class="modal-user-content" style="max-height: 90vh; height: 80vh;">
            <div class="modal-user-header">
                <span>üí¨ Tr·ª£ l√Ω H·ªèi ƒê√°p & T√¨m ki·∫øm</span>
                <span onclick="closeSearchModal()" style="cursor:pointer; padding:10px;">‚úï</span>
            </div>
            <div class="search-container">
                <div class="search-input-wrapper">
                    <input type="text" id="searchInput" placeholder="G√µ t·ª´ kh√≥a..." autocomplete="off">
                    <button onclick="performSearch()">T√åM</button>
                </div>
                <div class="faq-suggestions" id="faqSuggestions">
                    <p>üí° G·ª£i √Ω c√¢u h·ªèi th∆∞·ªùng g·∫∑p:</p>
                    <div class="faq-chips">
                        <div class="faq-chip" onclick="quickAsk('d·ª± b·ªã bi·ªÉu quy·∫øt')">ƒê·∫£ng vi√™n d·ª± b·ªã bi·ªÉu quy·∫øt?</div>
                        <div class="faq-chip" onclick="quickAsk('m·∫•t th·∫ª ƒë·∫£ng')">M·∫•t th·∫ª ƒê·∫£ng?</div>
                    </div>
                </div>
                <div id="searchResults"><div class="no-result">G√µ t·ª´ kh√≥a ƒë·ªÉ t√¨m ki·∫øm...</div></div>
            </div>
        </div>
    </div>

    <div id="modalTrichDan" class="modal-user" onclick="closeModalOnBgClick(event, 'modalTrichDan')">
        <div class="modal-user-content">
            <div class="modal-user-header"><span>N·ªôi dung chi ti·∫øt</span><span onclick="closePopup('modalTrichDan')" style="cursor:pointer; padding:10px;">‚úï</span></div>
            <div class="modal-user-body" id="noi-dung-chi-tiet"></div>
        </div>
    </div>

    <div id="loginOverlay">
        <div class="trong-dong-bg"></div>
        <div class="login-card">
            <div class="close-login" onclick="closeLoginForm()">‚úï</div>
            <div class="login-header">
                <div class="party-logo"><img src="image_359e62.png" onerror="this.src='https://i.postimg.cc/Qd05R7n2/image-359e62.png'"></div>
                <h2>ƒêƒÇNG NH·∫¨P</h2><p>H·ªá th·ªëng Qu·∫£n tr·ªã ƒê·ªìng th·ªùi</p>
            </div>
            <div class="login-body">
                <div class="input-group"><span class="input-icon">üë§</span><input type="text" id="username" placeholder="T√™n ƒëƒÉng nh·∫≠p (VD: nguyenthithanhtam, ledinhkien)"></div>
                <div class="input-group"><span class="input-icon">üîí</span><input type="password" id="password" placeholder="M·∫≠t kh·∫©u"></div>
                <div class="login-error" id="loginError">T√†i kho·∫£n ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ƒë√∫ng!</div>
                <button class="btn-login" onclick="processLogin()">V√ÄO TRANG QU·∫¢N TR·ªä</button>
            </div>
        </div>
    </div>

    <div id="adminPanel">
        <div class="admin-layout">
            <div class="admin-sidebar">
                <div style="font-weight:bold; margin-bottom:10px; color: var(--primary-color);">C√ÇY TH∆Ø M·ª§C CHUNG</div>
                <button class="btn btn-add" style="width: 100%;" onclick="addNewRoot()">+ Th√™m Ph·∫ßn L·ªõn</button>
                <div class="tree-container" id="adminTree"></div>
            </div>

            <div class="admin-main">
                <div style="border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h2 style="margin:0; color: var(--primary-color);">Bi√™n t·∫≠p N·ªôi dung</h2>
                        <div id="adminWelcome" style="color:#27ae60; font-weight:bold; font-size:0.9rem;"></div>
                    </div>
                    <button class="btn btn-close" onclick="closeAdminPanel()">Tho√°t Qu·∫£n tr·ªã</button>
                </div>

                <div id="editorArea" style="display:none; padding-bottom: 80px;">
                    <div style="text-align: right; margin-bottom: 10px;">
                        <button class="btn btn-delete" style="font-size: 0.8rem;" onclick="deleteCurrentItem()">X√≥a m·ª•c n√†y</button>
                    </div>
                    
                    <label style="font-weight:bold; color:#555;">Lo·∫°i (Tag):</label>
                    <input type="text" id="inpTag" class="form-control" placeholder="VD: H·ªèi ƒë√°p, Quy tr√¨nh...">
                    
                    <label style="font-weight:bold; color:#555;">Ti√™u ƒë·ªÅ:</label>
                    <input type="text" id="inpTitle" class="form-control" placeholder="Nh·∫≠p ti√™u ƒë·ªÅ...">
                    
                    <label style="font-weight:bold; color:#555;">N·ªôi dung t√≥m t·∫Øt:</label>
                    <textarea id="inpSummary" class="form-control" rows="4"></textarea>
                    
                    <label style="font-weight:bold; color:#555;">Tr√≠ch d·∫´n g·ªëc:</label>
                    <textarea id="inpDetail" class="form-control" rows="5"></textarea>
                    
                    <div style="background: #e8f5e9; border: 1px dashed #4caf50; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <label style="font-weight:bold; color:#2e7d32;">üìé Link Google Drive ƒë√≠nh k√®m</label>
                        <input type="text" id="inpFileUrl" class="form-control" style="border-color:#81c784; margin-bottom:10px;" placeholder="D√°n link v√†o ƒë√¢y...">
                        <input type="text" id="inpFileName" class="form-control" style="border-color:#81c784;" placeholder="T√™n file hi·ªÉn th·ªã">
                    </div>

                    <button class="btn btn-add" style="background:#17a2b8" onclick="addSubItem()">+ Th√™m m·ª•c con c·∫•p d∆∞·ªõi tr·ª±c ti·∫øp</button>

                    <div style="position: sticky; bottom: 0; background: rgba(255,255,255,0.9); padding: 15px 0; border-top: 1px solid #eee;">
                        <button id="btnSaveSingle" class="btn btn-save" onclick="saveCurrentNodeToServer()">üíæ L∆ØU THAY ƒê·ªîI CHO M·ª§C N√ÄY</button>
                    </div>
                </div>
                
                <div id="editorPlaceholder" style="text-align:center; color:#999; margin-top:50px;">
                    <span style="font-size: 40px; color: #ddd;">üëà</span><br>H√£y ch·ªçn m·ªôt m·ª•c b√™n tr√°i ƒë·ªÉ ch·ªânh s·ª≠a ƒë·ªôc l·∫≠p
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        // C·∫§U H√åNH FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyAN6SAuJhlkYtnuqVclEBhMn2Jz565Q7gs",
            authDomain: "sotay-dangvien.firebaseapp.com",
            projectId: "sotay-dangvien",
            storageBucket: "sotay-dangvien.firebasestorage.app",
            messagingSenderId: "699788813951",
            appId: "1:699788813951:web:14eb81183799f83e0f814a"
        };
        if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
        const db = firebase.firestore();

        // DANH S√ÅCH T√ÄI KHO·∫¢N (ƒêƒÉng nh·∫≠p c√πng l√∫c tho·∫£i m√°i)
        const ADMIN_ACCOUNTS = {
            "admin": { pass: "123456", name: "Qu·∫£n tr·ªã vi√™n H·ªá th·ªëng" },
            "nguyenthithanhtam": { pass: "123456", name: "Nguy·ªÖn Th·ªã Thanh T√¢m" },
            "nguyenhuuhung": { pass: "123456", name: "Nguy·ªÖn H·ªØu H√πng" },
            "tranthikieuanh": { pass: "123456", name: "Tr·∫ßn Th·ªã Ki·ªÅu Anh" },
            "tranphuongha": { pass: "123456", name: "Tr·∫ßn Ph∆∞∆°ng H√†" },
            "nguyensynghiem": { pass: "123456", name: "Nguy·ªÖn S·ªπ Nghi√™m" },
            "nguyenthugiang": { pass: "123456", name: "Nguy·ªÖn Thu Giang" },
            "phamthithuhanh": { pass: "123456", name: "Ph·∫°m Thi Thu H·∫°nh" }
        };

        let APP_DATA = [];
        let currentEditNodeId = null; // Ch·ªâ l∆∞u ID ƒë·ªÉ tr√°nh b·ªã l·ªói tham chi·∫øu khi ng∆∞·ªùi kh√°c s·ª≠a
        let loggedInUser = null;

        // L·∫ÆNG NGHE D·ªÆ LI·ªÜU TH·ªúI GIAN TH·ª∞C (Real-time Sync)
        db.collection("sotay").doc("dulieu").onSnapshot((doc) => {
            if (doc.exists) {
                APP_DATA = doc.data().treeData || [];
            } else {
                APP_DATA = [{ id: 'r1', title: 'PH·∫¶N 1', tag: '', summary: '', detail: '', level: 0, children: [] }];
            }
            
            renderUserInterface(); // C·∫≠p nh·∫≠t S·ªï tay b√™n ngo√†i cho m·ªçi ng∆∞·ªùi ƒë·ªçc
            
            // N·∫øu ƒëang m·ªü trang qu·∫£n tr·ªã, c·∫≠p nh·∫≠t l·∫°i c√¢y th∆∞ m·ª•c
            if (document.getElementById('adminPanel').style.display === 'block') { 
                renderAdminTree(); 
            }
        });

        // ==================================================================
        // C∆† CH·∫æ GIAO D·ªäCH (TRANSACTION) - C·ªêT L√ïI ƒê·ªÇ L√ÄM VI·ªÜC NH√ìM
        // ==================================================================
        
        // 1. L∆∞u thay ƒë·ªïi c·ªßa 1 M·ª•c c·ª• th·ªÉ
        function saveCurrentNodeToServer() {
            if (!currentEditNodeId) return;

            const btn = document.getElementById('btnSaveSingle');
            btn.innerText = "‚è≥ ƒêang ƒë·ªìng b·ªô..."; btn.disabled = true;

            // Gom d·ªØ li·ªáu ng∆∞·ªùi d√πng v·ª´a g√µ tr√™n form
            let updatedData = {
                tag: document.getElementById('inpTag').value,
                title: document.getElementById('inpTitle').value,
                summary: document.getElementById('inpSummary').value,
                detail: document.getElementById('inpDetail').value,
                fileUrl: document.getElementById('inpFileUrl').value,
                fileName: document.getElementById('inpFileName').value
            };

            const docRef = db.collection("sotay").doc("dulieu");

            // Ch·∫°y Transaction (T·∫£i b·∫£n m·ªõi nh·∫•t -> H·ª£p nh·∫•t -> L∆∞u l√™n)
            db.runTransaction((transaction) => {
                return transaction.get(docRef).then((doc) => {
                    let serverTree = doc.data().treeData || [];
                    let isFound = false;

                    // Thu·∫≠t to√°n ƒë·ªá quy t√¨m ƒë√∫ng ID tr√™n server ƒë·ªÉ ƒë√® d·ªØ li·ªáu m·ªõi v√†o
                    function updateNode(nodes) {
                        for(let i=0; i<nodes.length; i++) {
                            if(nodes[i].id === currentEditNodeId) {
                                // Ghi ƒë√® th√¥ng tin m·ªõi, nh∆∞ng gi·ªØ nguy√™n c√°c thu·ªôc t√≠nh c·∫•u tr√∫c (nh∆∞ children, level)
                                nodes[i] = { ...nodes[i], ...updatedData };
                                isFound = true;
                                return;
                            }
                            if(nodes[i].children) updateNode(nodes[i].children);
                        }
                    }

                    updateNode(serverTree);

                    if (isFound) {
                        // Ch·ªâ l∆∞u khi t√¨m th·∫•y ƒë√∫ng m·ª•c ƒë√≥ (tr√°nh l·ªói ai ƒë√≥ v·ª´a x√≥a m·ª•c n√†y)
                        transaction.update(docRef, { treeData: serverTree });
                    } else {
                        throw "M·ª•c n√†y c√≥ th·ªÉ ƒë√£ b·ªã ng∆∞·ªùi kh√°c x√≥a tr∆∞·ªõc ƒë√≥!";
                    }
                });
            }).then(() => {
                btn.innerText = "üíæ L∆ØU THAY ƒê·ªîI CHO M·ª§C N√ÄY"; btn.disabled = false;
                
                // N√∫t chuy·ªÉn sang xanh nh√°y nh√°y b√°o th√†nh c√¥ng
                btn.style.background = "#27ae60";
                setTimeout(() => { btn.style.background = "#28a745"; }, 2000);
            }).catch((err) => {
                btn.innerText = "üíæ L∆ØU THAY ƒê·ªîI CHO M·ª§C N√ÄY"; btn.disabled = false;
                alert("L·ªói ƒë·ªìng b·ªô: " + err);
            });
        }

        // 2. Th√™m Ph·∫ßn l·ªõn m·ªõi (Transaction)
        function addNewRoot() { 
            let newNode = {id: 'r'+Date.now(), title:'PH·∫¶N M·ªöI T·∫†O', tag:'', summary:'', detail:'', level:0, children:[]};
            
            const docRef = db.collection("sotay").doc("dulieu");
            db.runTransaction((transaction) => {
                return transaction.get(docRef).then((doc) => {
                    let serverTree = doc.data().treeData || [];
                    serverTree.push(newNode);
                    transaction.update(docRef, { treeData: serverTree });
                });
            }).then(() => { selectItem(newNode.id); }); 
        }

        // 3. Th√™m M·ª•c con (Transaction)
        function addSubItem() { 
            if(!currentEditNodeId) return;
            // T√¨m level c·ªßa m·ª•c cha ƒë·ªÉ t√≠nh level cho m·ª•c con
            let parentNode = findNode(currentEditNodeId, APP_DATA);
            if(!parentNode) return;

            let newNode = {id: 'n'+Date.now(), title:'M·ª•c con m·ªõi', tag:'', summary:'', detail:'', level: parentNode.level + 1, children:[]};

            const docRef = db.collection("sotay").doc("dulieu");
            db.runTransaction((transaction) => {
                return transaction.get(docRef).then((doc) => {
                    let serverTree = doc.data().treeData || [];
                    
                    function appendChild(nodes) {
                        for(let i=0; i<nodes.length; i++) {
                            if(nodes[i].id === currentEditNodeId) {
                                if(!nodes[i].children) nodes[i].children = [];
                                nodes[i].children.push(newNode);
                                return true;
                            }
                            if(nodes[i].children && appendChild(nodes[i].children)) return true;
                        }
                        return false;
                    }

                    appendChild(serverTree);
                    transaction.update(docRef, { treeData: serverTree });
                });
            }).then(() => { selectItem(newNode.id); }); 
        }

        // 4. X√≥a M·ª•c (Transaction)
        function deleteCurrentItem() { 
            if(!currentEditNodeId || !confirm('C·∫£nh b√°o: B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a m·ª•c n√†y? To√†n b·ªô m·ª•c con c≈©ng s·∫Ω b·ªã x√≥a!')) return; 

            const docRef = db.collection("sotay").doc("dulieu");
            db.runTransaction((transaction) => {
                return transaction.get(docRef).then((doc) => {
                    let serverTree = doc.data().treeData || [];
                    
                    // T√¨m cha c·ªßa m·ª•c c·∫ßn x√≥a
                    function removeNode(nodes) {
                        let idx = nodes.findIndex(c => c.id === currentEditNodeId);
                        if(idx > -1) {
                            nodes.splice(idx, 1);
                            return true;
                        }
                        for(let i=0; i<nodes.length; i++){
                            if(nodes[i].children && removeNode(nodes[i].children)) return true;
                        }
                        return false;
                    }

                    removeNode(serverTree);
                    transaction.update(docRef, { treeData: serverTree });
                });
            }).then(() => { 
                currentEditNodeId = null; 
                document.getElementById('editorArea').style.display='none'; 
                document.getElementById('editorPlaceholder').style.display='block';
            }); 
        }


        // ==================================================================
        // C√ÅC H√ÄM X·ª¨ L√ù GIAO DI·ªÜN (UI) C√íN L·∫†I
        // ==================================================================
        function processLogin() { 
            let user = document.getElementById('username').value.trim().toLowerCase(); 
            let pass = document.getElementById('password').value; 
            let errBox = document.getElementById('loginError');
            
            if (ADMIN_ACCOUNTS[user] && ADMIN_ACCOUNTS[user].pass === pass) { 
                loggedInUser = user;
                document.getElementById('loginOverlay').style.display = 'none'; 
                document.getElementById('adminPanel').style.display = 'block'; 
                document.getElementById('adminWelcome').innerHTML = `ƒêang ƒëƒÉng nh·∫≠p b·ªüi: <b>${ADMIN_ACCOUNTS[user].name}</b> <br><span style='color:#666; font-size:0.8rem; font-weight:normal;'>* H·ªá th·ªëng ƒë√£ k√≠ch ho·∫°t c∆° ch·∫ø L∆∞u ƒë·ªôc l·∫≠p. Nhi·ªÅu ng∆∞·ªùi c√≥ th·ªÉ s·ª≠a c√πng l√∫c.</span>`;
                renderAdminTree(); 
            } else { 
                errBox.style.display = 'block'; 
                document.getElementById('password').value = ''; 
            } 
        }
        function openLoginForm() { toggleMenu(false); document.getElementById('loginOverlay').style.display = 'flex'; }
        function closeLoginForm() { document.getElementById('loginOverlay').style.display = 'none'; }
        function closeAdminPanel() { document.getElementById('adminPanel').style.display = 'none'; loggedInUser = null; }

        // T√¨m node trong c√¢y
        function findNode(id, nodes) { 
            for(let node of nodes) { 
                if(node.id === id) return node; 
                if(node.children) { let f = findNode(id, node.children); if(f) return f; } 
            } return null; 
        }

        function renderAdminTree() {
            const tree = document.getElementById('adminTree');
            tree.innerHTML = '';
            function buildHtml(nodes) {
                let html = '';
                nodes.forEach(node => {
                    let active = (currentEditNodeId === node.id) ? 'active' : '';
                    let icon = node.level === 0 ? 'üìö' : (node.level === 1 ? 'üìÇ' : (node.level === 2 ? 'üìÑ' : (node.level === 3 ? 'üìë' : 'üìù')));
                    let extraClass = node.level === 0 ? 'root-item' : 'sub-item';
                    html += `<div class="tree-node"><div class="tree-item ${extraClass} ${active}" onclick="selectItem('${node.id}')"><span style="margin-right: 8px;">${icon}</span> <span>${node.title || 'Ch∆∞a ƒë·∫∑t t√™n'}</span></div>`;
                    if(node.children && node.children.length > 0) { html += `<div class="tree-children">${buildHtml(node.children)}</div>`; }
                    html += `</div>`;
                });
                return html;
            }
            tree.innerHTML = buildHtml(APP_DATA);
        }

        // ƒê·ªï d·ªØ li·ªáu v√†o Form b√™n ph·∫£i khi click v√†o 1 m·ª•c
        function selectItem(id) {
            currentEditNodeId = id;
            let nodeData = findNode(id, APP_DATA);
            if(!nodeData) return;

            renderAdminTree(); // L√†m xanh c√°i v·ª´a b·∫•m
            
            document.getElementById('editorPlaceholder').style.display = 'none';
            document.getElementById('editorArea').style.display = 'block';
            
            // X√≥a r·ªóng r·ªìi ƒë·ªï d·ªØ li·ªáu v√†o
            document.getElementById('inpTag').value = nodeData.tag || '';
            document.getElementById('inpTitle').value = nodeData.title || '';
            document.getElementById('inpSummary').value = nodeData.summary || '';
            document.getElementById('inpDetail').value = nodeData.detail || '';
            document.getElementById('inpFileUrl').value = nodeData.fileUrl || '';
            document.getElementById('inpFileName').value = nodeData.fileName || '';
        }

        // Logic M·∫π b·ªìng con (L·ªìng gh√©p Accordion ngo√†i trang ƒë·ªçc)
        function toggleStep(headerEl, event) {
            if (event && (event.target.closest('a') || event.target.closest('.btn-trich-dan'))) return;
            if (event) event.stopPropagation();
            const stepBox = headerEl.parentElement;
            let parentInner = stepBox.parentElement;
            if (parentInner) {
                let siblings = parentInner.children;
                for(let i=0; i<siblings.length; i++) {
                    if (siblings[i] !== stepBox && siblings[i].classList.contains('step-box')) siblings[i].classList.remove('active');
                }
            }
            stepBox.classList.toggle('active');
        }

        function renderUserInterface() {
            const menuEl = document.getElementById('menuList');
            const contentEl = document.getElementById('dynamicContent');
            menuEl.innerHTML = ''; contentEl.innerHTML = '';
            if (!APP_DATA || APP_DATA.length === 0) return;

            function processNode(items, container) {
                items.forEach(item => {
                    if(item.level <= 3) {
                        let li = document.createElement('li');
                        let indent = item.level === 1 ? '&nbsp;&nbsp;üìÇ ' : (item.level === 2 ? '&nbsp;&nbsp;&nbsp;&nbsp;üìÑ ' : '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;üîπ ');
                        li.innerHTML = `<a onclick="toggleMenu(false); jumpToResult('${item.id}')">${indent}${item.title || 'M·ª•c ch∆∞a c√≥ t√™n'}</a>`;
                        menuEl.appendChild(li);
                    }
                    
                    let div = document.createElement('div'); div.id = item.id;
                    let innerContent = '';
                    let downloadBtn = item.fileUrl ? `<a href="${item.fileUrl}" target="_blank" class="inline-download" title="${item.fileName || 'T·∫£i bi·ªÉu m·∫´u'}">üì• T·∫£i m·∫´u</a>` : '';
                    let nextContainer = container; 

                    if(item.level === 0 || item.level === 1) {
                        let hTag = item.level === 0 ? 'h2' : 'h3';
                        let hClass = item.level === 0 ? 'phan-header' : 'muc-header';
                        innerContent += `<${hTag} class="${hClass}">${item.title || 'Ch∆∞a ƒë·∫∑t t√™n'} ${downloadBtn}</${hTag}>`;
                        if (item.summary) innerContent += `<p>${item.summary.replace(/\n/g, '<br>')}</p>`;
                        if (item.detail) innerContent += `<div class="step-actions"><div class="btn-trich-dan" onclick="showPopup('${item.detail.replace(/'/g, "\\'").replace(/"/g, '&quot;').replace(/\n/g, '<br>')} ')">üìñ Xem quy ƒë·ªãnh chi ti·∫øt</div></div>`;
                        div.innerHTML = innerContent;
                        container.appendChild(div);
                    } else {
                        let levelClass = item.level === 2 ? 'level-2' : (item.level === 3 ? 'level-3' : 'level-4');
                        let titleHtml = item.level === 2 ? `<div style="font-weight: 700; font-size: 1.15em; color: #2980b9; margin-bottom: 0;">${item.title || 'Ch∆∞a ƒë·∫∑t t√™n'} ${downloadBtn}</div>` : (item.level === 3 ? `<div style="font-weight: 700; font-size: 1.05em; color: #27ae60; margin-bottom: 0;">${item.title || 'Ch∆∞a ƒë·∫∑t t√™n'} ${downloadBtn}</div>` : `<div class="step-number" style="margin-bottom:0">${item.title || 'Ch∆∞a ƒë·∫∑t t√™n'} ${downloadBtn}</div>`);
                        div.className = `step-box ${levelClass}`;
                        let tagHtml = item.tag ? `<span class="tag-label">${item.tag}</span>` : '';
                        let summaryHtml = item.summary ? `<p style="margin-top:0">${item.summary.replace(/\n/g, '<br>')}</p>` : '';
                        let detailBtn = item.detail ? `<div class="step-actions" style="margin-top:10px; margin-bottom:5px;"><div class="btn-trich-dan" onclick="showPopup('${item.detail.replace(/'/g, "\\'").replace(/"/g, '&quot;').replace(/\n/g, '<br>')} ')">üìñ Xem chi ti·∫øt</div></div>` : '';
                        
                        div.innerHTML = `<div class="step-header" onclick="toggleStep(this, event)"><div class="step-title-wrapper">${tagHtml}${titleHtml}</div><div class="step-icon">‚ñº</div></div><div class="step-body-wrapper"><div class="step-body"><div class="step-body-inner" id="inner-${item.id}">${summaryHtml}${detailBtn}</div></div></div>`;
                        container.appendChild(div);
                        nextContainer = div.querySelector(`#inner-${item.id}`);
                    }
                    if(item.children && item.children.length > 0) processNode(item.children, nextContainer);
                });
            }
            processNode(APP_DATA, contentEl);
        }

        // Logic T√¨m ki·∫øm
        function openSearchModal() { document.getElementById('modalSearch').style.display = 'flex'; document.getElementById('searchInput').value = ''; document.getElementById('faqSuggestions').style.display = 'block'; document.getElementById('searchResults').innerHTML = '<div class="no-result">G√µ t·ª´ kh√≥a ƒë·ªÉ t√¨m...</div>'; document.getElementById('searchInput').focus(); }
        function closeSearchModal() { document.getElementById('modalSearch').style.display = 'none'; }
        function quickAsk(keyword) { document.getElementById('searchInput').value = keyword; performSearch(); }
        function removeAccents(str) { return str ? str.normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase() : ""; }
        function performSearch() {
            let kwNoAccent = removeAccents(document.getElementById('searchInput').value.trim());
            let resContainer = document.getElementById('searchResults');
            let faqDiv = document.getElementById('faqSuggestions');
            if (kwNoAccent.length < 2) { resContainer.innerHTML = '<div class="no-result">Vui l√≤ng g√µ √≠t nh·∫•t 2 k√Ω t·ª±.</div>'; faqDiv.style.display = 'block'; return; }
            faqDiv.style.display = 'none';
            let results = [];
            function traverse(nodes, parentPath) {
                for(let n of nodes) {
                    let curPath = parentPath ? (parentPath + " > " + n.title) : (n.title || '');
                    if (removeAccents((n.title||'')+" "+(n.tag||'')+" "+(n.summary||'')+" "+(n.detail||'')).includes(kwNoAccent)) {
                        results.push({ id: n.id, path: parentPath || 'M·ª•c ch√≠nh', title: n.title, snippet: n.summary || 'Chi ti·∫øt...' });
                    }
                    if (n.children) traverse(n.children, curPath);
                }
            }
            traverse(APP_DATA, "");
            if (results.length === 0) resContainer.innerHTML = '<div class="no-result">‚ùå Kh√¥ng t√¨m th·∫•y.</div>';
            else {
                let html = ''; results.forEach(r => html += `<div class="result-item" onclick="jumpToResult('${r.id}')"><div class="result-path">üìÇ ${r.path}</div><div class="result-title">${r.title}</div><div class="result-snippet">${r.snippet}</div></div>`);
                resContainer.innerHTML = html;
            }
        }
        document.getElementById('searchInput').addEventListener('keypress', e => { if (e.key === 'Enter') performSearch(); });
        
        function jumpToResult(id) {
            closeSearchModal();
            let el = document.getElementById(id);
            if (el) {
                let parentNode = el.parentElement;
                while (parentNode && parentNode.id !== 'dynamicContent') {
                    if (parentNode.classList.contains('step-box')) parentNode.classList.add('active');
                    parentNode = parentNode.parentElement;
                }
                if (el.classList.contains('step-box')) el.classList.add('active');
                setTimeout(() => {
                    el.scrollIntoView({ behavior: "smooth", block: "start" });
                    let oBg = el.style.backgroundColor; el.style.backgroundColor = "#fff3cd"; setTimeout(() => el.style.backgroundColor = oBg || '', 2000);
                }, 150);
            }
        }

        // Ti·ªán √≠ch
        function toggleMenu(f) { const sb = document.getElementById('sidebar'); const ov = document.querySelector('.overlay'); if (typeof f !== 'undefined') { if(f) { sb.classList.add('active'); ov.classList.add('active'); } else { sb.classList.remove('active'); ov.classList.remove('active'); } } else { sb.classList.toggle('active'); ov.classList.toggle('active'); } }
        function showPopup(html) { document.getElementById('noi-dung-chi-tiet').innerHTML = html; document.getElementById('modalTrichDan').style.display = 'flex'; }
        function closePopup(id) { document.getElementById(id).style.display = 'none'; }
        function closeModalOnBgClick(e, id) { if(e.target.id === id) closePopup(id); }
        window.onscroll = () => document.getElementById("backToTop").style.display = (document.body.scrollTop > 300 || document.documentElement.scrollTop > 300) ? "block" : "none";
        function topFunction() { document.body.scrollTop = 0; document.documentElement.scrollTop = 0; }
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>S·ªï tay Nghi·ªáp v·ª• C√¥ng t√°c T·ªï ch·ª©c ƒê·∫£ng</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#cc0000">
    <link rel="icon" type="image/png" href="https://upload.wikimedia.org/wikipedia/commons/thumb/e/ea/Flag_of_the_Communist_Party_of_Vietnam.svg/1200px-Flag_of_the_Communist_Party_of_Vietnam.svg.png">

    <style>
        /* CSS CHUNG */
        :root { --primary: #cc0000; --primary-dark: #a30000; --text: #333; --sidebar-bg: #2c3e50; --header-h: 50px; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; line-height: 1.6; color: var(--text); margin: 0; background: #f4f4f4; }
        .mobile-header { display: none; position: fixed; top: 0; left: 0; right: 0; height: var(--header-h); background: var(--primary); color: white; align-items: center; padding: 0 15px; z-index: 2000; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .menu-btn { background: none; border: none; color: white; font-size: 24px; cursor: pointer; margin-right: 15px; }
        .app-title { font-weight: bold; text-transform: uppercase; font-size: 1rem; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
        @media (max-width: 992px) { .mobile-header { display: flex; } }
        .sidebar { width: 280px; background: var(--sidebar-bg); color: white; padding: 20px; position: fixed; top: 0; bottom: 0; left: 0; overflow-y: auto; z-index: 3000; transition: transform 0.3s ease; box-shadow: 2px 0 5px rgba(0,0,0,0.1); }
        @media (max-width: 992px) { .sidebar { transform: translateX(-100%); width: 85%; max-width: 320px; } .sidebar.active { transform: translateX(0); } }
        .sidebar h3 { border-bottom: 1px solid #555; padding-bottom: 15px; margin-top: 0; color: #f1c40f; text-align: center; }
        .nav-list { list-style: none; padding: 0; }
        .nav-link { display: block; padding: 12px 15px; color: #ecf0f1; text-decoration: none; border-bottom: 1px solid rgba(255,255,255,0.05); transition:0.2s; }
        .nav-link:hover { background: var(--primary); padding-left: 20px; }
        .overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 2500; display: none; backdrop-filter: blur(2px); }
        .overlay.active { display: block; }
        .main { padding: 20px; background: white; min-height: 100vh; transition: margin-left 0.3s; }
        @media (min-width: 992px) { .main { margin-left: 280px; padding: 40px 60px; } }
        @media (max-width: 992px) { .main { padding-top: 70px; } }
        h1 { color: var(--primary); border-bottom: 3px solid var(--primary); padding-bottom: 15px; margin-top: 0; font-size: 1.6rem; text-transform: uppercase; }
        .phan-header { background: #fcebeb; padding: 15px; border-left: 6px solid var(--primary); margin-top: 30px; color: var(--primary-dark); font-size: 1.3em; font-weight: bold; }
        .muc-header { color: #b71c1c; margin-top: 25px; font-weight: 700; font-size: 1.1em; }
        .step-box { background: #fff; border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 3px 6px rgba(0,0,0,0.05); }
        .tag-label { font-size: 0.75rem; text-transform: uppercase; color: #666; font-weight: bold; display: block; margin-bottom: 5px; }
        .step-title { font-weight: bold; color: var(--primary); margin-bottom: 10px; display: block; font-size: 1.05rem; }
        .btn-detail { display: inline-flex; align-items: center; justify-content: center; margin-top: 15px; background: #e3f2fd; color: #0d47a1; padding: 10px 20px; border-radius: 6px; border: 1px solid #90caf9; font-weight: bold; cursor: pointer; width: 100%; text-decoration:none; }
        @media (min-width: 768px) { .btn-detail { width: auto; } }
        .data-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.9rem; border: 1px solid #ddd; }
        .data-table th, .data-table td { border: 1px solid #ddd; padding: 10px; text-align: left; vertical-align: top; }
        .data-table th { background-color: #f2f2f2; color: var(--primary-dark); font-weight: bold; text-align: center; }
        .data-table tr:nth-child(even) { background-color: #fafafa; }
        .data-table tr:hover { background-color: #f1f1f1; }
        .modal { display: none; position: fixed; z-index: 4000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); align-items: center; justify-content: center; padding: 10px; }
        .modal-box { background: white; width: 100%; max-width: 800px; border-radius: 10px; overflow: hidden; max-height: 90vh; display: flex; flex-direction: column; animation: slideUp 0.3s; }
        .modal-head { background: var(--primary); color: white; padding: 15px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 20px; overflow-y: auto; line-height: 1.6; text-align: justify; }
        @keyframes slideUp { from {transform: translateY(20px); opacity:0} to {transform: translateY(0); opacity:1} }
        #adminPanel { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 5000; flex-direction: column; }
        @media (min-width: 768px) { #adminPanel { flex-direction: row; } }
        .admin-sidebar { background: #f8f9fa; border-bottom: 1px solid #ddd; padding: 10px; display: flex; flex-direction: column; }
        @media (min-width: 768px) { .admin-sidebar { width: 300px; height: 100vh; border-right: 1px solid #ddd; border-bottom: none; } }
        .admin-main { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; }
        .form-control { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; font-family: inherit; }
        .btn { padding: 10px 15px; border: none; border-radius: 4px; color: white; cursor: pointer; font-weight: bold; margin-bottom: 5px; }
        .btn-save { background: #28a745; } .btn-close { background: #6c757d; } .btn-del { background: #dc3545; } .btn-add { background: #007bff; }
        #backToTop { display: none; position: fixed; bottom: 20px; right: 20px; z-index: 90; border: none; background: var(--primary); color: white; padding: 12px; border-radius: 50%; cursor: pointer; }
        #loadingBar { position:fixed; top:0; left:0; height:4px; background:#28a745; z-index:9999; transition: width 0.3s; width:0%; }
        .error-msg { text-align:center; color:#999; padding:20px; }
    </style>
</head>
<body>
    <div id="loadingBar"></div>
    <div class="mobile-header">
        <button class="menu-btn" onclick="toggleMenu()">‚ò∞</button>
        <span class="app-title">S·ªî TAY NGHI·ªÜP V·ª§</span>
    </div>

    <div class="overlay" onclick="toggleMenu()"></div>
    <div class="sidebar" id="sidebar">
        <div style="text-align:right"><span onclick="toggleMenu()" style="cursor:pointer; font-size:1.5rem; padding:5px;">‚úï</span></div>
        <h3>M·ª§C L·ª§C</h3>
        <ul class="nav-list" id="menuList"></ul>
        <div style="margin-top:30px; text-align:center; font-size:0.8rem; color:#999; border-top:1px solid #444; padding-top:20px;">
            <p>&copy; 2025 Ban T·ªï ch·ª©c Th√†nh ·ªßy</p>
            <span onclick="checkAdmin()" style="cursor:pointer; opacity:0.5">üîí Qu·∫£n tr·ªã h·ªá th·ªëng</span>
            <p id="dbStatus" style="font-size:0.7rem; color:#28a745; margin-top:5px; font-weight:bold">‚òÅÔ∏è ƒêang k·∫øt n·ªëi...</p>
        </div>
    </div>

    <div class="main">
        <h1>H∆Ø·ªöNG D·∫™N NGHI·ªÜP V·ª§ C√îNG T√ÅC ƒê·∫¢NG VI√äN (2025)</h1>
        <p><i>(CƒÉn c·ª© H∆∞·ªõng d·∫´n s·ªë 10-HD/BTCTU c·ªßa Ban T·ªï ch·ª©c Th√†nh ·ªßy H√† N·ªôi)</i></p>
        <div id="dynamicContent"><p class="error-msg">‚è≥ ƒêang t·∫£i d·ªØ li·ªáu t·ª´ m√°y ch·ªß...</p></div>
        <br><br><br>
    </div>

    <div id="popup" class="modal" onclick="closePopup(event)">
        <div class="modal-box">
            <div class="modal-head">
                <span>N·ªôi dung chi ti·∫øt</span>
                <span onclick="document.getElementById('popup').style.display='none'" style="cursor:pointer; font-size:1.2rem">‚úï</span>
            </div>
            <div class="modal-body" id="popupContent"></div>
        </div>
    </div>

    <button id="backToTop" onclick="window.scrollTo({top:0, behavior:'smooth'})">‚¨Ü</button>

    <div id="adminPanel">
        <div class="admin-sidebar">
            <div style="font-weight:bold; margin-bottom:10px">C·∫§U TR√öC S·ªî TAY</div>
            <button class="btn btn-add" onclick="addNewRoot()">+ Th√™m Ph·∫ßn L·ªõn</button>
            <div id="adminTree" style="flex:1; overflow-y:auto; margin-top:10px; border:1px solid #eee; background:white;"></div>
        </div>
        <div class="admin-main">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px; border-bottom:1px solid #eee; padding-bottom:10px">
                <h2 style="margin:0">Bi√™n t·∫≠p n·ªôi dung</h2>
                <div>
                    <button class="btn btn-save" onclick="saveToCloud()">‚òÅÔ∏è L∆ØU L√äN M√ÅY CH·ª¶</button>
                    <button class="btn btn-close" onclick="document.getElementById('adminPanel').style.display='none'">ƒê√≥ng</button>
                </div>
            </div>
            <div id="editorArea" style="display:none">
                <div style="text-align:right"><button class="btn btn-del" onclick="deleteItem()">X√≥a m·ª•c n√†y</button></div>
                <label>Lo·∫°i (Tag):</label><input type="text" id="inpTag" class="form-control" placeholder="VD: Quy tr√¨nh, H∆∞·ªõng d·∫´n...">
                <label>Ti√™u ƒë·ªÅ:</label><input type="text" id="inpTitle" class="form-control">
                <label>N·ªôi dung hi·ªÉn th·ªã (T√≥m t·∫Øt):</label><textarea id="inpSummary" class="form-control" rows="5"></textarea>
                <label>N·ªôi dung chi ti·∫øt (Popup/B·∫£ng bi·ªÉu):</label><p style="font-size:0.8rem; color:#666; margin:0"><i>D√°n m√£ HTML b·∫£ng v√†o ƒë√¢y.</i></p><textarea id="inpDetail" class="form-control" rows="8"></textarea>
                <div style="margin-top:15px; border-top:1px dashed #ccc; padding-top:15px"><button class="btn btn-add" style="background:#17a2b8" onclick="addSubItem()">+ Th√™m m·ª•c con</button></div>
            </div>
            <div id="editorPlaceholder" style="text-align:center; color:#999; margin-top:50px">Ch·ªçn m·ªôt m·ª•c b√™n tr√°i ƒë·ªÉ s·ª≠a</div>
        </div>
    </div>

    <script type="module">
        // -------------------------------------------------------------
        // 1. C·∫§U H√åNH FIREBASE (ƒê√É S·ª¨A L·∫†I CHU·∫®N CDN)
        // -------------------------------------------------------------
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // ƒê√¢y l√† m√£ c·ªßa b·∫°n, t√¥i ƒë√£ ƒëi·ªÅn ƒë√∫ng ƒë·ªãnh d·∫°ng
        const firebaseConfig = {
            apiKey: "AIzaSyAN6SAuJhlkYtnuqVclEBhMn2Jz565Q7gs",
            authDomain: "sotay-dangvien.firebaseapp.com",
            projectId: "sotay-dangvien",
            storageBucket: "sotay-dangvien.firebasestorage.app",
            messagingSenderId: "699788813951",
            appId: "1:699788813951:web:14eb81183799f83e0f814a"
        };

        let db;
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            console.log("Firebase initialized");
        } catch(e) {
            console.error("Firebase error", e);
        }

        // -------------------------------------------------------------
        // 2. D·ªÆ LI·ªÜU & LOGIC
        // -------------------------------------------------------------
        const initialData = [
            { id: 'p1', title: 'ƒêANG T·∫¢I D·ªÆ LI·ªÜU...', tag: '', summary: 'Vui l√≤ng ƒë·ª£i trong gi√¢y l√°t...', detail: '', level: 0, children: [] }
        ];

        let APP_DATA = initialData;
        let currentEditNode = null;

        // T·∫£i d·ªØ li·ªáu (C√≥ Timeout 5 gi√¢y ƒë·ªÉ ch·ªëng treo)
        async function loadFromCloud() {
            document.getElementById('loadingBar').style.width = '30%';
            
            // ƒê·∫∑t th·ªùi gian ch·ªù t·ªëi ƒëa 5 gi√¢y
            const timeoutPromise = new Promise((resolve) => setTimeout(() => resolve('TIMEOUT'), 5000));
            
            try {
                // ƒêua t·ªëc ƒë·ªô: Ai xong tr∆∞·ªõc th√¨ l·∫•y
                const result = await Promise.race([fetchData(), timeoutPromise]);

                if (result === 'TIMEOUT') {
                    console.warn("M·∫°ng ch·∫≠m, d√πng d·ªØ li·ªáu Offline");
                    loadOffline();
                    document.getElementById('dbStatus').innerText = "‚ö†Ô∏è Ch·∫ø ƒë·ªô Offline";
                } else {
                    console.log("D·ªØ li·ªáu Online OK");
                    document.getElementById('dbStatus').innerText = "‚úÖ ƒê√£ k·∫øt n·ªëi M√°y ch·ªß";
                }
            } catch (err) {
                console.error(err);
                loadOffline();
            }
            
            document.getElementById('loadingBar').style.width = '100%';
            setTimeout(() => { document.getElementById('loadingBar').style.width = '0%'; }, 500);
        }

        async function fetchData() {
            if(!db) throw new Error("No DB");
            const docRef = doc(db, "sotay_db", "master_data");
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                if(data.content) {
                    APP_DATA = JSON.parse(data.content);
                    renderUI();
                    return 'OK';
                }
            }
            // N·∫øu ch∆∞a c√≥ data tr√™n m√¢y, th·ª≠ load offline
            loadOffline(); 
            return 'OK';
        }

        function loadOffline() {
            try {
                const s = localStorage.getItem('SOTAY_DATA_FINAL');
                if(s) { 
                    APP_DATA = JSON.parse(s); 
                    renderUI();
                } else {
                    document.getElementById('dynamicContent').innerHTML = '<p class="error-msg">Kh√¥ng c√≥ d·ªØ li·ªáu. Vui l√≤ng v√†o Admin ƒë·ªÉ kh·ªüi t·∫°o.</p>';
                }
            } catch(e) { console.error(e); }
        }

        window.saveToCloud = async function() {
            if(!db) { alert("L·ªói c·∫•u h√¨nh!"); return; }
            const btn = document.querySelector('.btn-save');
            if(btn) { btn.innerText = "‚è≥ ƒêang l∆∞u..."; btn.disabled = true; }

            try {
                await setDoc(doc(db, "sotay_db", "master_data"), {
                    content: JSON.stringify(APP_DATA),
                    updatedAt: new Date().toISOString()
                });
                localStorage.setItem('SOTAY_DATA_FINAL', JSON.stringify(APP_DATA));
                alert("‚úÖ ƒê√É L∆ØU TH√ÄNH C√îNG!");
                renderUI();
            } catch (error) {
                alert("L·ªói: " + error.message);
            }
            if(btn) { btn.innerText = "‚òÅÔ∏è L∆ØU L√äN M√ÅY CH·ª¶"; btn.disabled = false; }
        }

        // -------------------------------------------------------------
        // 3. GIAO DI·ªÜN (UI)
        // -------------------------------------------------------------
        function renderUI() {
            const menu = document.getElementById('menuList');
            const content = document.getElementById('dynamicContent');
            menu.innerHTML = ''; content.innerHTML = '';

            if(!APP_DATA || APP_DATA.length === 0) {
                content.innerHTML = '<p class="error-msg">Ch∆∞a c√≥ d·ªØ li·ªáu.</p>';
                return;
            }

            function processNode(items) {
                items.forEach(item => {
                    if(item.level < 2) {
                        let li = document.createElement('li');
                        let indent = item.level === 1 ? '&nbsp;&nbsp;üìÇ ' : '';
                        li.innerHTML = `<a href="#${item.id}" class="nav-link" onclick="window.toggleMenu(false)">${indent}${item.title}</a>`;
                        menu.appendChild(li);
                    }
                    let div = document.createElement('div');
                    div.id = item.id;
                    if(item.level === 0) div.innerHTML = `<div class="phan-header">${item.title}</div>`;
                    else if (item.level === 1) {
                        div.innerHTML = `<div class="muc-header">${item.title}</div>`;
                        if(item.summary) div.innerHTML += `<p>${item.summary.replace(/\n/g, '<br>')}</p>`;
                    } else {
                        let btnHtml = (item.detail && item.detail.trim() !== "") ? 
                            `<a class="btn-detail" onclick="window.openPopup('${item.id}')">üìñ Xem chi ti·∫øt / Bi·ªÉu m·∫´u</a>` : '';
                        div.className = 'step-box';
                        div.innerHTML = `${item.tag ? `<span class="tag-label">${item.tag}</span>` : ''}<span class="step-title">${item.title}</span><div style="font-size:0.95rem">${item.summary.replace(/\n/g, '<br>')}</div>${btnHtml}`;
                    }
                    content.appendChild(div);
                    if(item.children) processNode(item.children);
                });
            }
            processNode(APP_DATA);
        }

        // Global functions
        window.toggleMenu = function(forceState) {
            const sb = document.getElementById('sidebar');
            const ov = document.querySelector('.overlay');
            if(typeof forceState !== 'undefined') {
                if(forceState) { sb.classList.add('active'); ov.classList.add('active'); }
                else { sb.classList.remove('active'); ov.classList.remove('active'); }
            } else { sb.classList.toggle('active'); ov.classList.toggle('active'); }
        }
        window.openPopup = function(id) {
            const item = findNodeRecursive(id, APP_DATA);
            if(item) { document.getElementById('popupContent').innerHTML = item.detail; document.getElementById('popup').style.display = 'flex'; }
        }
        window.closePopup = function(e) { if(e.target.id === 'popup') document.getElementById('popup').style.display='none'; }
        window.checkAdmin = function() {
            let p = prompt("M·∫≠t kh·∫©u (btctuhn@123):");
            if(p === "btctuhn@123") { document.getElementById('adminPanel').style.display = 'flex'; window.renderAdminTree(); } 
            else if (p !== null) { alert("Sai m·∫≠t kh·∫©u!"); }
        }

        // Admin Helpers
        function findNodeRecursive(id, nodes) {
            for(let node of nodes) {
                if(node.id === id) return node;
                if(node.children) { let found = findNodeRecursive(id, node.children); if(found) return found; }
            } return null;
        }
        window.renderAdminTree = function() {
            const container = document.getElementById('adminTree');
            container.innerHTML = '';
            function buildHtml(nodes) {
                let html = '';
                nodes.forEach(node => {
                    let active = (currentEditNode && currentEditNode.id === node.id) ? 'background:#e3f2fd; color:#007bff; font-weight:bold;' : '';
                    let icon = node.level === 0 ? 'üìö' : (node.level === 1 ? 'üìÇ' : 'üìÑ');
                    let padding = node.level * 20 + 10;
                    html += `<div style="padding:10px; padding-left:${padding}px; border-bottom:1px solid #eee; cursor:pointer; ${active}" onclick="window.selectItem('${node.id}')">${icon} ${node.title}</div>`;
                    if(node.children) html += buildHtml(node.children);
                });
                return html;
            }
            container.innerHTML = buildHtml(APP_DATA);
        }
        window.selectItem = function(id) {
            currentEditNode = findNodeRecursive(id, APP_DATA);
            window.renderAdminTree();
            document.getElementById('editorPlaceholder').style.display = 'none';
            document.getElementById('editorArea').style.display = 'block';
            document.getElementById('inpTag').value = currentEditNode.tag || '';
            document.getElementById('inpTitle').value = currentEditNode.title || '';
            document.getElementById('inpSummary').value = currentEditNode.summary || '';
            document.getElementById('inpDetail').value = currentEditNode.detail || '';
        }
        ['inpTag', 'inpTitle', 'inpSummary', 'inpDetail'].forEach(fid => {
            document.getElementById(fid).addEventListener('input', function() {
                if(!currentEditNode) return;
                let prop = fid.replace('inp','').toLowerCase();
                if(prop === 'tag') currentEditNode.tag = this.value;
                if(prop === 'title') currentEditNode.title = this.value;
                if(prop === 'summary') currentEditNode.summary = this.value;
                if(prop === 'detail') currentEditNode.detail = this.value;
                if(prop === 'title') window.renderAdminTree();
            });
        });
        window.addNewRoot = function() { APP_DATA.push({id: 'r'+Date.now(), title:'PH·∫¶N M·ªöI', tag:'', summary:'', detail:'', level:0, children:[]}); window.renderAdminTree(); }
        window.addSubItem = function() { 
            if(!currentEditNode) return; 
            if(!currentEditNode.children) currentEditNode.children = [];
            currentEditNode.children.push({id: 'n'+Date.now(), title:'M·ª•c m·ªõi', tag:'', summary:'', detail:'', level: currentEditNode.level+1, children:[]});
            window.renderAdminTree(); 
        }
        window.deleteItem = function() {
            if(!currentEditNode || !confirm('X√≥a m·ª•c n√†y?')) return;
            const findParent = (id, nodes) => {
                for(let node of nodes) {
                    if(node.children && node.children.some(c => c.id === id)) return node;
                    let f = findParent(id, node.children || []); if(f) return f;
                } return null;
            }
            let p = findParent(currentEditNode.id, APP_DATA);
            if(p) { let idx = p.children.findIndex(c=>c.id === currentEditNode.id); p.children.splice(idx,1); }
            else { let idx = APP_DATA.findIndex(c=>c.id === currentEditNode.id); APP_DATA.splice(idx,1); }
            currentEditNode = null; document.getElementById('editorArea').style.display='none'; window.renderAdminTree();
        }

        // Start
        loadFromCloud();
    </script>
</body>
</html>
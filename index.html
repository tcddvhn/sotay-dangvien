<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S·ªï tay Nghi·ªáp v·ª• C√¥ng t√°c T·ªï ch·ª©c ƒê·∫£ng</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#cc0000">

    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

    <style>
        :root { 
            --primary-color: #cc0000; 
            --primary-dark: #a30000; 
            --yellow-party: #f1c40f; 
            --bg-sidebar: #2c3e50; 
            --header-height: 55px;
            --bg-main: #f4f4f4;
            --bg-box: #ffffff;
            --bg-header: #fdfdfd;
            --text-main: #333333;
            --text-muted: #666666;
            --border-color: #e0e0e0;
            --border-light: #eeeeee;
            --bg-hover: #f9f9f9;
            --bg-phan: #fcebeb;
            --text-phan: #a30000;
            --text-muc: #b71c1c;
            --shadow-color: rgba(0,0,0,0.05);
        }

        body.dark-mode {
            --bg-main: #121212;
            --bg-box: #1e1e1e;
            --bg-header: #2a2a2a;
            --text-main: #e0e0e0;
            --text-muted: #aaaaaa;
            --border-color: #333333;
            --border-light: #444444;
            --bg-hover: #2c2c2c;
            --bg-phan: #3a1c1c;
            --text-phan: #ff6b6b;
            --text-muc: #ff8a8a;
            --shadow-color: rgba(0,0,0,0.5);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { font-family: 'Times New Roman', Times, serif; line-height: 1.6; color: var(--text-main); margin: 0; background-color: var(--bg-main); font-size: 1.15rem; transition: background-color 0.3s, color 0.3s; }
        
        #readingProgress { position: fixed; top: 0; left: 0; height: 3px; background: var(--yellow-party); width: 0%; z-index: 9999; transition: width 0.1s; }

        #breadcrumbBar { position: sticky; top: var(--header-height); background: var(--bg-main); padding: 10px 15px; font-size: 0.85rem; color: var(--text-muted); z-index: 800; font-family: -apple-system, sans-serif; border-bottom: 1px solid var(--border-color); display: none; white-space: nowrap; overflow-x: auto; font-weight: bold;}
        #breadcrumbBar span { cursor: pointer; color: var(--primary-color); }
        #breadcrumbBar span:hover { text-decoration: underline; }

        .top-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .toggle-btn { background: var(--bg-box); color: var(--text-main); border: 1px solid var(--border-color); padding: 6px 12px; border-radius: 20px; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center; gap: 5px; box-shadow: 0 2px 4px var(--shadow-color); transition: 0.3s; font-family: -apple-system, sans-serif; font-weight: bold;}
        .toggle-btn:hover { background: var(--bg-hover); }

        .sidebar { width: 320px; background-color: var(--bg-sidebar); color: white; padding: 20px 0; position: fixed; top: 0; bottom: 0; left: 0; overflow-y: auto; z-index: 1000; transition: transform 0.3s ease; box-shadow: 2px 0 5px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
        .sidebar h3 { border-bottom: 1px solid #555; padding-bottom: 15px; margin-top: 20px; text-transform: uppercase; font-size: 1.1rem; text-align: center; color: var(--yellow-party); font-family: -apple-system, sans-serif; }
        
        /* ========================================================= */
        /* FIX L·ªñI DASHBOARD (C·∫¢I THI·ªÜN TOOLTIP BI·ªÇU ƒê·ªí)             */
        /* ========================================================= */
        .mini-dashboard { background: rgba(0,0,0,0.15); margin: 0 10px 15px 10px; padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.05); font-family: -apple-system, sans-serif;}
        .stat-row { display: flex; justify-content: space-between; align-items: center; font-size: 0.75rem; color: #ecf0f1; margin-bottom: 6px; white-space: nowrap; }
        .stat-row b { color: var(--yellow-party); font-size: 0.85rem; margin-left: 5px;}
        
        .chart-container { display: flex; align-items: flex-end; gap: 4px; height: 45px; margin-top: 10px; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 2px; }
        .chart-bar { flex: 1; background: #5dade2; border-radius: 4px 4px 0 0; position: relative; cursor: pointer; transition: height 0.4s ease, background 0.2s;}
        .chart-bar:hover { background: var(--yellow-party); }
        
        /* ƒê√ÇY L√Ä ƒêO·∫†N CSS B·ªä M·∫§T KHI·∫æN CH·ªÆ TR√ÄN RA: C·∫•u h√¨nh Bong b√≥ng hi·ªÉn th·ªã s·ªë li·ªáu */
        .chart-tooltip { position: absolute; top: -26px; left: 50%; transform: translateX(-50%); background: #fff; color: #000; font-size: 0.7rem; padding: 3px 6px; border-radius: 4px; display: none; white-space: nowrap; font-weight:bold; box-shadow: 0 2px 4px rgba(0,0,0,0.3); z-index: 10; pointer-events: none;}
        .chart-tooltip::after { content: ''; position: absolute; top: 100%; left: 50%; margin-left: -4px; border-width: 4px; border-style: solid; border-color: #fff transparent transparent transparent;}
        .chart-bar:hover .chart-tooltip { display: block; }
        
        .chart-labels { display: flex; justify-content: space-between; font-size: 0.65rem; color: #aaa; margin-top: 4px; font-weight: bold;}

        .sidebar-menu-tree { font-family: -apple-system, sans-serif; font-size: 0.95rem; padding: 0 10px;}
        .sidebar-menu-tree ul { list-style: none; padding-left: 15px; margin: 0; display: none; }
        .sidebar-menu-tree > ul { padding-left: 0; display: block; } 
        .sidebar-menu-tree ul.active { display: block; }
        .menu-item-row { display: flex; align-items: flex-start; padding: 8px 5px; border-bottom: 1px solid rgba(255,255,255,0.05); color: #ecf0f1; transition: 0.2s; }
        .menu-item-row:hover { background-color: rgba(255,255,255,0.1); }
        .menu-toggle { display: inline-block; width: 20px; text-align: center; cursor: pointer; color: #aaa; user-select: none; font-size: 0.75rem; padding-top: 3px;}
        .menu-toggle:hover { color: var(--yellow-party); }
        .menu-link { flex: 1; cursor: pointer; text-decoration: none; color: inherit; padding-left: 5px; border-radius: 4px; transition: 0.2s;}
        .menu-link:hover { color: white; text-shadow: 0 0 5px rgba(255,255,255,0.5); }
        .menu-link.active-menu { color: var(--yellow-party) !important; font-weight: bold; background: rgba(255,255,255,0.1); padding: 2px 8px; border-left: 3px solid var(--yellow-party); }

        .close-sidebar-btn { text-align: right; margin-bottom: 10px; display: none; padding-right: 15px;}
        
        .top-header { position: fixed; top: 0; left: 0; right: 0; height: var(--header-height); background: var(--primary-color); z-index: 990; display: flex; align-items: center; padding: 0 15px; justify-content: space-between; color: white; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.2); font-family: -apple-system, sans-serif; }
        .menu-toggle-btn { background: none; border: none; color: white; font-size: 24px; cursor: pointer; margin-right: 15px; }
        .header-title { font-size: 1.15rem; letter-spacing: 0.5px; flex:1;}
        .header-actions { display: flex; gap: 10px; align-items: center; }

        @media (min-width: 1200px) { .main-content { padding: 85px 80px 40px 80px !important; } }
        @media (min-width: 992px) { .top-header { left: 320px; } .menu-toggle-btn { display: none; } .main-content { margin-left: 320px; padding: 85px 60px 40px 60px; } #btnSearchFab { left: 350px !important; } }

        .overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 999; display: none; backdrop-filter: blur(2px); }
        .overlay.active { display: block; }

        .main-content { padding: 75px 15px 20px 15px; min-height: 100vh; transition: margin-left 0.3s ease; overflow-x: hidden; }
        h1 { color: var(--primary-color); border-bottom: 3px solid var(--primary-color); padding-bottom: 15px; margin-top: 0; font-size: 1.5rem; text-transform: uppercase; line-height: 1.3; font-family: -apple-system, sans-serif; }
        
        .phan-header { background-color: var(--bg-phan); padding: 15px; border-left: 6px solid var(--primary-color); margin-top: 30px; color: var(--text-phan); font-size: 1.25em; font-weight: bold; border-radius: 4px; transition: background-color 0.3s;}
        .muc-header { color: var(--text-muc); margin-top: 25px; margin-bottom: 15px; font-weight: 700; font-size: 1.15em; transition: color 0.3s; }
        
        /* KH√îI PH·ª§C C·∫§U TR√öC PH·∫≤NG - KH√îNG "M·∫∏ B·ªíNG CON" */
        .step-box { background: var(--bg-box); margin-bottom: 10px; position: relative; scroll-margin-top: 100px; transition: background-color 0.3s; }
        
        .main-content > div > .step-box { border: 1px solid var(--border-color); border-radius: 8px; box-shadow: 0 2px 4px var(--shadow-color); margin-top: 15px; }
        .main-content > div > .step-box > .step-header { border-radius: 8px; }
        .main-content > div > .step-box.active > .step-header { border-radius: 8px 8px 0 0; border-bottom: 1px solid var(--border-light); background-color: var(--bg-header); }

        .step-body .step-box { border: none; border-top: 1px dashed var(--border-light); margin: 0; padding: 0; box-shadow: none; border-radius: 0; background: transparent;}
        .step-body .step-box > .step-header { background: transparent; border-radius: 0; }
        .step-body .step-box.active > .step-header { background-color: var(--bg-hover); }

        .step-body .step-box.level-2 > .step-header { border-left: 4px solid #2980b9; padding-left: 20px; } 
        .step-body .step-box.level-3 > .step-header { border-left: 3px solid #27ae60; padding-left: 35px; } 
        .step-body .step-box.level-4 > .step-header { border-left: 2px solid var(--primary-color); padding-left: 50px; } 

        .step-header { padding: 14px 15px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: background 0.2s; background-color: var(--bg-box);}
        .step-header:hover { background: var(--bg-hover); }
        .step-title-wrapper { flex: 1; padding-right: 10px; }
        .step-icon { color: var(--text-muted); transition: transform 0.3s ease; font-size: 0.85rem; padding-left: 5px;}

        .step-body-wrapper { display: grid; grid-template-rows: 0fr; transition: grid-template-rows 0.35s ease; }
        .step-box.active > .step-body-wrapper { grid-template-rows: 1fr; }
        .step-body { overflow: hidden; opacity: 0; transform: translateY(-5px); transition: opacity 0.35s ease, transform 0.35s ease; }
        .step-box.active > .step-body-wrapper > .step-body { opacity: 1; transform: translateY(0); }
        
        .content-text { padding: 15px; text-align: justify; }
        .content-text p, .modal-user-body p { margin-top: 0; margin-bottom: 10px; }
        .content-text p:last-child, .modal-user-body p:last-child { margin-bottom: 0; }
        .content-text ul, .content-text ol, .modal-user-body ul, .modal-user-body ol { margin: 10px 0; padding-left: 25px; }

        .step-box.active > .step-header .step-icon { transform: rotate(180deg); color: var(--primary-color); }
        .step-number { background: #3498db; color: white; padding: 4px 12px; border-radius: 20px; font-weight: bold; display: inline-block; font-size: 0.9rem; font-family: -apple-system, sans-serif;}
        .tag-label { font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted); font-weight: bold; margin-bottom: 4px; display: block; letter-spacing: 0.5px; font-family: -apple-system, sans-serif;}
        
        .step-actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px;}
        .btn-trich-dan { display: inline-flex; align-items: center; background-color: rgba(52, 152, 219, 0.1); color: #2980b9; padding: 8px 12px; border-radius: 6px; border: 1px solid rgba(52, 152, 219, 0.3); font-size: 0.9em; cursor: pointer; font-weight: 600; justify-content: center; font-family: -apple-system, sans-serif; transition: 0.2s;}
        .btn-trich-dan:hover { background-color: #2980b9; color: white; }
        .inline-download { display: inline-flex; align-items: center; justify-content: center; background-color: rgba(39, 174, 96, 0.1); color: #27ae60; padding: 4px 10px; border-radius: 12px; border: 1px solid rgba(39, 174, 96, 0.3); font-size: 0.85rem; font-weight: bold; text-decoration: none; margin-left: 10px; vertical-align: middle; white-space: nowrap; font-family: -apple-system, sans-serif; transition: 0.2s; }
        .inline-download:hover { background-color: #27ae60; color: white; }

        mark.search-highlight { background-color: #ffe082; color: #000; padding: 2px 4px; border-radius: 4px; font-weight: bold; }
        #btnSearchFab { position: fixed; bottom: 30px; left: 20px; z-index: 90; border: none; background: transparent; color: var(--primary-dark); cursor: pointer; font-size: 2rem; transition: 0.3s; padding: 0; filter: drop-shadow(2px 2px 2px rgba(255,255,255,0.9)); }
        #btnSearchFab:hover { transform: scale(1.1); color: var(--primary-color); }
        #backToTop { display: none; position: fixed; bottom: 30px; right: 20px; z-index: 90; border: none; background: transparent; color: var(--primary-color); cursor: pointer; font-size: 2.2rem; transition: 0.3s; padding: 0; font-weight: bold; filter: drop-shadow(2px 2px 2px rgba(255,255,255,0.9)); }
        #backToTop:hover { transform: translateY(-5px); color: var(--primary-dark); }

        .modal-user { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); padding: 10px; align-items: center; justify-content: center; backdrop-filter: blur(3px);}
        .modal-user-content { background-color: var(--bg-box); color: var(--text-main); width: 100%; max-width: 800px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); display: flex; flex-direction: column; max-height: 85vh; animation: slideUp 0.3s; }
        .modal-user-header { background-color: var(--primary-color); color: white; padding: 15px; border-radius: 12px 12px 0 0; font-weight: bold; display: flex; justify-content: space-between; align-items: center; font-family: -apple-system, sans-serif;}
        .modal-user-body { padding: 25px 15px; line-height: 1.6; overflow-y: auto; text-align: justify; font-size: 1.15rem; }
        @keyframes slideUp { from {transform: translateY(20px); opacity: 0;} to {transform: translateY(0); opacity: 1;} }
        .btn-close-modal { cursor: pointer; background: rgba(255, 255, 255, 0.2); border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; transition: 0.2s; font-size: 1rem; }
        .btn-close-modal:hover { background: rgba(255, 255, 255, 0.4); transform: scale(1.1); }

        .search-container { padding: 20px 15px; font-family: -apple-system, sans-serif; display: flex; flex-direction: column; flex: 1; overflow: hidden;}
        .search-input-wrapper { display: flex; gap: 10px; border: none; border-radius: 8px; margin-bottom: 15px; flex-shrink: 0; flex-wrap: wrap;}
        .search-input-wrapper select { padding: 12px; border: 2px solid var(--primary-color); border-radius: 8px; font-size: 0.95rem; outline: none; background: var(--bg-box); color: var(--text-main); font-weight:bold;}
        .search-input-core { display: flex; flex: 1; border: 2px solid var(--primary-color); border-radius: 8px; overflow: hidden; min-width: 200px;}
        .search-input-core input { flex: 1; padding: 12px 15px; border: none; font-size: 1rem; outline: none; background: var(--bg-box); color: var(--text-main);}
        .search-input-core button { background: var(--primary-color); color: white; border: none; padding: 0 20px; font-weight: bold; cursor: pointer;}
        
        .faq-suggestions { padding-bottom: 15px; border-bottom: 1px solid var(--border-light); margin-bottom: 10px; flex-shrink: 0;}
        .faq-suggestions p { margin: 0 0 10px 0; font-size: 0.95rem; color: var(--text-muted); font-weight: bold; }
        .faq-chips { display: flex; flex-wrap: wrap; gap: 8px; }
        .faq-chip { background: var(--bg-main); border: 1px solid var(--border-color); padding: 8px 12px; border-radius: 20px; font-size: 0.9rem; cursor: pointer; transition: 0.2s; }
        .faq-chip:hover { border-color: var(--primary-color); color: var(--primary-color); }
        #searchResults { overflow-y: auto; flex: 1; font-family: 'Times New Roman', Times, serif;}
        .result-item { padding: 15px 10px; border-bottom: 1px solid var(--border-light); cursor: pointer; transition: 0.2s;}
        .result-item:hover { background: var(--bg-hover); }
        .result-path { font-size: 0.85rem; color: var(--text-muted); font-family: -apple-system, sans-serif; margin-bottom: 5px;}
        .result-title { font-weight: bold; color: #2980b9; font-size: 1.1rem; margin-bottom: 5px; font-family: -apple-system, sans-serif;}
        .result-snippet { font-size: 1.05rem; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;}
        .no-result { text-align: center; color: var(--text-muted); padding: 20px; font-family: -apple-system, sans-serif;}

        @media (max-width: 768px) { 
            body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; font-size: 1.05rem; }
            .sidebar { transform: translateX(-100%); width: 85%; max-width: 320px; } 
            .sidebar.active { transform: translateX(0); } 
            .close-sidebar-btn { display: block; }
            #btnSearchFab, #backToTop { bottom: 20px; } 
            .step-header { padding: 16px 15px; } 
            .btn-trich-dan { width: 100%; margin-bottom: 5px;}
            #breadcrumbBar { top: 55px; }
            .modal-user { padding: 15px; }
            .modal-user-content { height: 90vh !important; max-height: 90vh !important; border-radius: 12px !important; }
            .modal-user-header { border-radius: 12px 12px 0 0 !important; }
            
            .step-body .step-box.level-2 > .step-header { padding-left: 15px; }
            .step-body .step-box.level-3 > .step-header { padding-left: 25px; }
            .step-body .step-box.level-4 > .step-header { padding-left: 35px; }
        }

        #loginOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 6000; align-items: center; justify-content: center; overflow: hidden; background-color: #8c0000; font-family: -apple-system, sans-serif; }
        .trong-dong-bg { position: absolute; width: 100%; height: 100%; top: 0; left: 0; z-index: -1; background-image: linear-gradient(rgba(0,0,0,0.4), rgba(0,0,0,0.4)), url('img_5-hinh-nen-powerpoint-trong-dong.jpg'); background-size: cover; background-position: center; background-repeat: no-repeat; }
        .login-card { background: rgba(255, 255, 255, 0.98); width: 90%; max-width: 400px; padding: 40px 30px; border-radius: 20px; box-shadow: 0 15px 35px rgba(0,0,0,0.5); position: relative; animation: zoomIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); color: #333;}
        @keyframes zoomIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .close-login { position: absolute; top: 15px; right: 20px; font-size: 24px; color: #999; cursor: pointer; transition: 0.2s; }
        .login-header { text-align: center; margin-bottom: 25px; }
        .party-logo img { width: 110px; height: auto; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.2)); }
        .login-header h2 { margin: 0; color: var(--primary-dark); font-size: 1.5rem; text-transform: uppercase; }
        .input-group { display: flex; align-items: center; background: #f0f2f5; border: 1px solid #e4e6eb; border-radius: 10px; margin-bottom: 20px; padding: 5px 15px; transition: 0.3s; }
        .input-icon { color: #888; font-size: 18px; margin-right: 10px; }
        .input-group input { border: none; background: transparent; padding: 12px 0; width: 100%; font-size: 16px; outline: none; color: #333;}
        .login-error { color: #dc3545; font-size: 0.9rem; text-align: center; margin-top: -10px; margin-bottom: 15px; display: none; }
        .btn-login { width: 100%; background: linear-gradient(135deg, #cc0000, #a30000); color: white; border: none; padding: 15px; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; text-transform: uppercase; box-shadow: 0 4px 10px rgba(204,0,0,0.3); }

        #adminPanel { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 5000; overflow-y: auto; font-family: -apple-system, sans-serif; color:#333;}
        .admin-layout { display: flex; height: 100%; flex-direction: column; }
        @media (min-width: 768px) { .admin-layout { flex-direction: row; } }
        .admin-sidebar { background: #f8f9fa; border-bottom: 1px solid #ddd; padding: 10px; height: 40vh; display: flex; flex-direction: column; }
        @media (min-width: 768px) { .admin-sidebar { width: 350px; min-width: 200px; max-width: 60vw; height: 100vh; border-right: 3px solid #ccc; border-bottom: none; resize: horizontal; overflow: auto; } }
        
        .tree-container { flex: 1; overflow-y: auto; border: 1px solid #ddd; background: #fff; border-radius: 6px; padding: 10px; font-family: 'Times New Roman', Times, serif; font-size: 1.15rem; box-shadow: inset 0 2px 4px rgba(0,0,0,0.02);}
        .tree-node { margin-bottom: 2px; }
        .tree-item { padding: 8px 10px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; transition: all 0.2s ease; border: 1px solid transparent; color: #444; }
        .tree-item.active { background: #e3f2fd; color: #0d47a1; font-weight: bold; border-left: 4px solid #007bff; }
        .tree-item.drag-over { border: 2px dashed #e67e22 !important; background-color: #fdf2e9 !important; box-shadow: 0 4px 10px rgba(230, 126, 34, 0.3); transform: scale(1.02); z-index: 10; transition: all 0.2s;} 
        .tree-item.dragging { opacity: 0.5; background-color: #ecf0f1; border: 1px dashed #999; }
        .root-item { font-weight: bold; background: #f8f9fa; border: 1px solid #eee; margin-top: 5px; color: var(--primary-dark); }
        .sub-item { position: relative; font-size: 1.05rem; }
        .tree-toggle { display: inline-block; width: 24px; text-align: center; cursor: pointer; color: #999; font-size: 0.8rem; font-family: Arial, sans-serif; transition: 0.2s; user-select: none; }
        .tree-toggle:hover { color: var(--primary-color); transform: scale(1.2); }
        .tree-children { margin-left: 20px; border-left: 1px dashed #ccc; padding-left: 10px; margin-top: 2px; }
        .tree-children.collapsed { display: none; }
        .btn-order { font-size: 0.9rem; padding: 2px 5px; background: rgba(0,0,0,0.05); border-radius: 4px; border: none; cursor: pointer; color: #666; display: none; }
        .btn-order:hover { background: rgba(0,0,0,0.1); color: var(--primary-color); }
        .tree-item:hover .btn-order { display: inline-block; }
        
        .admin-main { flex: 1; padding: 20px; overflow-y: auto; background: #fff; height: 60vh; position: relative;}
        @media (min-width: 768px) { .admin-main { height: 100vh; } }
        .form-control { font-family: 'Times New Roman', Times, serif; font-size: 1.15rem; width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 6px; margin-bottom: 15px; outline: none; color:#333;}
        .form-control:focus { border-color: #007bff; box-shadow: 0 0 5px rgba(0,123,255,0.25); }
        .btn { padding: 12px 20px; border: none; border-radius: 6px; font-weight: bold; color: white; cursor: pointer; margin-bottom: 10px; font-family: -apple-system, sans-serif;}
        .btn-close { background: #6c757d; } .btn-delete { background: #dc3545; } .btn-add { background: #007bff; }
        .admin-trigger { margin-top: 20px; text-align: center; padding: 15px; border-top: 1px solid rgba(255,255,255,0.2); cursor: pointer; color: #bdc3c7;}

        .ql-toolbar { border-radius: 6px 6px 0 0; font-family: -apple-system, sans-serif; background: #f8f9fa; border-color:#ccc !important;}
        .ql-container { border-radius: 0 0 6px 6px; font-family: 'Times New Roman', Times, serif; font-size: 1.15rem; background: #fff; margin-bottom: 15px; border-color:#ccc !important;}
        .ql-editor { min-height: 120px; }
    </style>
</head>
<body>

    <div id="readingProgress"></div>

    <div class="top-header">
        <div style="display:flex; align-items:center;">
            <button class="menu-toggle-btn" onclick="toggleMenu()">‚ò∞</button>
            <span class="header-title">S·ªî TAY NGHI·ªÜP V·ª§ TCƒê, ƒêV</span>
        </div>
        <div class="header-actions">
            <button class="toggle-btn" onclick="openSearchModal()" title="T√¨m ki·∫øm" style="background:transparent; border:none; color:white; font-size:1.2rem; box-shadow:none;">üîç</button>
            <button class="toggle-btn" onclick="toggleDarkMode()" title="Ch·∫ø ƒë·ªô T·ªëi/S√°ng" style="background:transparent; border:none; color:white; font-size:1.2rem; box-shadow:none;">üåì</button>
        </div>
    </div>

    <div id="breadcrumbBar">Trang ch·ªß</div>

    <div class="overlay" onclick="toggleMenu(false)"></div>
    
    <div class="sidebar" id="sidebar">
        <div class="close-sidebar-btn"><span onclick="toggleMenu(false)" style="cursor:pointer; color:#fff; font-size:1.5rem;">‚úï</span></div>
        <h3 style="margin-top:0">M·ª§C L·ª§C</h3>
        
        <div class="mini-dashboard" id="miniDashboard">
            <div style="text-align:center; color:#aaa; font-size:0.8rem;">ƒêang t·∫£i d·ªØ li·ªáu...</div>
        </div>
        
        <div id="recentViews" class="mini-dashboard" style="display:none; background:rgba(241, 196, 15, 0.1); border-color: rgba(241, 196, 15, 0.3);"></div>

        <div class="sidebar-menu-tree" id="menuList"></div>
        <div style="margin-top: auto;"></div>
        <div class="admin-trigger" onclick="openLoginForm()">‚öôÔ∏è ƒêƒÉng nh·∫≠p Qu·∫£n tr·ªã</div>
    </div>

    <div class="main-content">
        <h1>NGHI·ªÜP V·ª§ C√îNG T√ÅC T·ªî CH·ª®C ƒê·∫¢NG</h1>
        <div class="top-controls">
            <div style="display:flex; gap:10px;">
                <button class="toggle-btn" onclick="expandAll()">üìÇ M·ªü r·ªông t·∫•t c·∫£</button>
                <button class="toggle-btn" onclick="collapseAll()">üìÅ Thu g·ªçn t·∫•t c·∫£</button>
            </div>
        </div>
        <div id="dynamicContent"></div>
        <br><br><br>
    </div>

    <button id="btnSearchFab" onclick="openSearchModal()" title="T√¨m ki·∫øm">üîç</button>
    <button id="backToTop" onclick="topFunction()">‚¨Ü</button>

    <div id="modalSearch" class="modal-user" onclick="closeModalOnBgClick(event, 'modalSearch')">
        <div class="modal-user-content">
            <div class="modal-user-header">
                <span>üí¨ Tr·ª£ l√Ω H·ªèi ƒê√°p & T√¨m ki·∫øm</span>
                <span onclick="closeSearchModal()" class="btn-close-modal" title="ƒê√≥ng">‚úï</span>
            </div>
            <div class="search-container">
                <div class="search-input-wrapper">
                    <select id="searchTagFilter">
                        <option value="">üìÇ T·∫•t c·∫£ danh m·ª•c</option>
                        <option value="h·ªèi ƒë√°p">‚ùì H·ªèi ƒë√°p</option>
                        <option value="quy tr√¨nh">üìã Quy tr√¨nh</option>
                        <option value="bi·ªÉu m·∫´u">üìù Bi·ªÉu m·∫´u</option>
                        <option value="quy ƒë·ªãnh">‚öñÔ∏è Quy ƒë·ªãnh</option>
                    </select>
                    <div class="search-input-core">
                        <input type="text" id="searchInput" placeholder="Nh·∫≠p t·ª´ kh√≥a c·∫ßn t√¨m..." autocomplete="off">
                        <button onclick="performSearch()">T√åM</button>
                    </div>
                </div>
                <div class="faq-suggestions" id="faqSuggestions">
                    <p>üí° G·ª£i √Ω nhanh:</p>
                    <div class="faq-chips">
                        <div class="faq-chip" onclick="quickAsk('d·ª± b·ªã bi·ªÉu quy·∫øt')">ƒê·∫£ng vi√™n d·ª± b·ªã bi·ªÉu quy·∫øt?</div>
                        <div class="faq-chip" onclick="quickAsk('m·∫•t th·∫ª ƒë·∫£ng')">M·∫•t th·∫ª ƒê·∫£ng?</div>
                    </div>
                </div>
                <div id="searchResults"><div class="no-result">G√µ t·ª´ kh√≥a ƒë·ªÉ t√¨m ki·∫øm...</div></div>
            </div>
        </div>
    </div>

    <div id="modalTrichDan" class="modal-user" onclick="closeModalOnBgClick(event, 'modalTrichDan')">
        <div class="modal-user-content">
            <div class="modal-user-header">
                <span>N·ªôi dung chi ti·∫øt</span>
                <span onclick="closePopup('modalTrichDan')" class="btn-close-modal" title="ƒê√≥ng">‚úï</span>
            </div>
            <div class="modal-user-body" id="noi-dung-chi-tiet"></div>
        </div>
    </div>

    <div id="loginOverlay">
        <div class="trong-dong-bg"></div>
        <div class="login-card">
            <div class="close-login" onclick="closeLoginForm()">‚úï</div>
            <div class="login-header">
                <div class="party-logo"><img src="image_359e62.png" onerror="this.src='https://i.postimg.cc/Qd05R7n2/image-359e62.png'"></div>
                <h2>ƒêƒÇNG NH·∫¨P</h2><p>H·ªá th·ªëng Qu·∫£n tr·ªã ƒê·ªìng th·ªùi</p>
            </div>
            <div class="login-body">
                <div class="input-group"><span class="input-icon">üë§</span><input type="text" id="username" placeholder="T√™n ƒëƒÉng nh·∫≠p"></div>
                <div class="input-group"><span class="input-icon">üîí</span><input type="password" id="password" placeholder="M·∫≠t kh·∫©u"></div>
                <div class="login-error" id="loginError">T√†i kho·∫£n ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ƒë√∫ng!</div>
                <button class="btn-login" onclick="processLogin()">V√ÄO TRANG QU·∫¢N TR·ªä</button>
            </div>
        </div>
    </div>

    <div id="adminPanel">
        <div class="admin-layout">
            <div class="admin-sidebar">
                <div style="font-weight:bold; margin-bottom:5px; color: var(--primary-color);">C√ÇY TH∆Ø M·ª§C CHUNG</div>
                <div style="font-size: 0.8rem; color: #7f8c8d; margin-bottom: 10px; font-style: italic;">M·∫πo: K√©o th·∫£ th∆∞ m·ª•c ƒë·ªÉ chuy·ªÉn c·∫•p</div>
                
                <input type="text" id="adminSearchInput" class="form-control" style="padding: 8px; font-size: 0.95rem; font-family: -apple-system, sans-serif; margin-bottom: 10px;" placeholder="üîç L·ªçc nhanh th∆∞ m·ª•c ƒë·ªÉ s·ª≠a..." oninput="filterAdminTree()">

                <button class="btn btn-add" style="width: 100%;" onclick="addNewRoot()">+ Th√™m Ph·∫ßn L·ªõn</button>
                <div class="tree-container" id="adminTree"></div>
            </div>

            <div class="admin-main">
                <div style="border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h2 style="margin:0; color: var(--primary-color);">Bi√™n t·∫≠p N·ªôi dung</h2>
                        <div id="adminWelcome" style="color:#27ae60; font-weight:bold; font-size:0.9rem;"></div>
                    </div>
                    <button class="btn btn-close" onclick="closeAdminPanel()">Tho√°t Qu·∫£n tr·ªã</button>
                </div>

                <div id="editorArea" style="display:none; padding-bottom: 80px;">
                    <div style="text-align: right; margin-bottom: 10px;">
                        <button class="btn btn-delete" style="font-size: 0.8rem;" onclick="deleteCurrentItem()">X√≥a m·ª•c n√†y</button>
                    </div>
                    <label style="font-weight:bold; color:#555;">Lo·∫°i (Tag):</label>
                    <input type="text" id="inpTag" class="form-control" placeholder="VD: H·ªèi ƒë√°p, Quy tr√¨nh...">
                    
                    <label style="font-weight:bold; color:#555;">Ti√™u ƒë·ªÅ:</label>
                    <input type="text" id="inpTitle" class="form-control" placeholder="Nh·∫≠p ti√™u ƒë·ªÅ...">
                    
                    <label style="font-weight:bold; color:#555;">N·ªôi dung t√≥m t·∫Øt:</label>
                    <div id="inpSummary"></div>
                    
                    <label style="font-weight:bold; color:#555;">Tr√≠ch d·∫´n g·ªëc:</label>
                    <div id="inpDetail"></div>
                    
                    <div style="background: #e8f5e9; border: 1px dashed #4caf50; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <label style="font-weight:bold; color:#2e7d32;">üìé Link Google Drive ƒë√≠nh k√®m</label>
                        <input type="text" id="inpFileUrl" class="form-control" style="border-color:#81c784; margin-bottom:10px;" placeholder="D√°n link v√†o ƒë√¢y...">
                        <input type="text" id="inpFileName" class="form-control" style="border-color:#81c784;" placeholder="T√™n file hi·ªÉn th·ªã">
                    </div>

                    <button class="btn btn-add" style="background:#17a2b8" onclick="addSubItem()">+ Th√™m m·ª•c con c·∫•p d∆∞·ªõi tr·ª±c ti·∫øp</button>

                    <div style="position: sticky; bottom: 15px; display: flex; justify-content: flex-end; pointer-events: none; margin-top: 10px;">
                        <button id="btnSaveSingle" style="pointer-events: auto; background: #28a745; color: white; border: none; font-weight: bold; padding: 12px 20px; font-size: 1rem; border-radius: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.4); cursor: pointer; transition: 0.2s;" onclick="saveCurrentNodeToServer()">üíæ L∆ØU M·ª§C N√ÄY</button>
                    </div>
                </div>
                
                <div id="editorPlaceholder" style="text-align:center; color:#999; margin-top:50px;">
                    <span style="font-size: 40px; color: #ddd;">üëà</span><br>H√£y ch·ªçn m·ªôt m·ª•c b√™n tr√°i ƒë·ªÉ ch·ªânh s·ª≠a ƒë·ªôc l·∫≠p
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        let hasUnsavedChanges = false;
        let isSystemChangingContent = false; 

        var toolbarOptions = [['bold', 'italic', 'underline'], [{'list': 'ordered'}, {'list': 'bullet'}], ['link', 'clean']];
        var quillSummary = new Quill('#inpSummary', { theme: 'snow', modules: { toolbar: toolbarOptions }, placeholder: 'Nh·∫≠p n·ªôi dung t√≥m t·∫Øt...' });
        var quillDetail = new Quill('#inpDetail', { theme: 'snow', modules: { toolbar: toolbarOptions }, placeholder: 'So·∫°n th·∫£o tr√≠ch d·∫´n g·ªëc...' });

        function markAsUnsaved() {
            if (isSystemChangingContent || !currentEditNodeId || hasUnsavedChanges) return;
            hasUnsavedChanges = true;
            const btn = document.getElementById('btnSaveSingle');
            btn.style.background = "#f1c40f"; btn.style.color = "#000"; btn.innerHTML = "‚ö†Ô∏è ƒêANG CH·ªàNH S·ª¨A (B·∫•m ƒë·ªÉ L∆∞u)";
        }

        function resetSaveButton() {
            hasUnsavedChanges = false;
            const btn = document.getElementById('btnSaveSingle');
            btn.style.background = "#28a745"; btn.style.color = "#fff"; btn.innerHTML = "üíæ L∆ØU M·ª§C N√ÄY";
        }

        quillSummary.on('text-change', markAsUnsaved); quillDetail.on('text-change', markAsUnsaved);
        ['inpTag', 'inpTitle', 'inpFileUrl', 'inpFileName'].forEach(id => { document.getElementById(id).addEventListener('input', markAsUnsaved); });

        function processLegacyText(text) {
            if (!text) return '';
            if (text.indexOf('<p') === -1 && text.indexOf('<br') === -1 && text.indexOf('<ul') === -1 && text.indexOf('<ol') === -1) {
                return text.replace(/\n/g, '<br>');
            }
            return text;
        }

        function initTheme() {
            const savedTheme = localStorage.getItem('sotay_theme');
            if (savedTheme === 'dark') document.body.classList.add('dark-mode');
            else if (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches) document.body.classList.add('dark-mode');
        } initTheme();

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('sotay_theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
        }

        window.addEventListener('scroll', () => {
            let scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
            let height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
            let progress = (scrollTop / height) * 100;
            document.getElementById('readingProgress').style.width = progress + "%";
            document.getElementById("backToTop").style.display = scrollTop > 300 ? "block" : "none";
        });

        function addRecentView(id, title) {
            if(!id || !title) return;
            let recents = JSON.parse(localStorage.getItem('sotay_recents') || '[]');
            recents = recents.filter(item => item.id !== id);
            recents.unshift({id, title});
            if(recents.length > 5) recents.pop();
            localStorage.setItem('sotay_recents', JSON.stringify(recents));
            renderRecentViews();
        }

        function renderRecentViews() {
            let recents = JSON.parse(localStorage.getItem('sotay_recents') || '[]');
            let container = document.getElementById('recentViews');
            if(recents.length === 0) { container.style.display = 'none'; return; }
            container.style.display = 'block';
            let html = '<div style="font-size:0.75rem; color:#f39c12; margin-bottom:5px; text-transform:uppercase; font-weight:bold;">üïí V·ª´a xem g·∫ßn ƒë√¢y:</div>';
            recents.forEach(item => {
                html += `<div style="font-size:0.85rem; padding:4px 0; cursor:pointer; color:#ecf0f1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;" onclick="toggleMenu(false); jumpToResult('${item.id}')">‚ñ™ ${item.title}</div>`;
            });
            container.innerHTML = html;
        }

        const firebaseConfig = { apiKey: "AIzaSyAN6SAuJhlkYtnuqVclEBhMn2Jz565Q7gs", authDomain: "sotay-dangvien.firebaseapp.com", projectId: "sotay-dangvien", storageBucket: "sotay-dangvien.firebasestorage.app", messagingSenderId: "699788813951", appId: "1:699788813951:web:14eb81183799f83e0f814a" };
        if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
        const db = firebase.firestore();

        const ADMIN_ACCOUNTS = { "admin": { pass: "123456", name: "Qu·∫£n tr·ªã vi√™n H·ªá th·ªëng" }, "tranphuongha": { pass: "123456", name: "Tr·∫ßn Ph∆∞∆°ng H√†-Chuy√™n vi√™n" }, "ledinhkien": { pass: "123456", name: "L√™ ƒê√¨nh Ki√™n-Chuy√™n vi√™n" }, "nguyenhuuhung": { pass: "123456", name: "Nguy·ªÖn H·ªØu H√πng-chuy√™n vi√™n ch√≠nh" }, "tranthikieuanh": { pass: "123456", name: "Tr·∫ßn Th·ªã Ki·ªÅu Anh-Chuy√™n vi√™n" }, "trithingoc": { pass: "123456", name: "Tri·ªáu Th·ªã Ng·ªçc- Ph√≥ Tr∆∞·ªüng Ban Th∆∞·ªùng tr·ª±c" }, "nguyensinghiem": { pass: "123456", name: "Nguy·ªÖn Sƒ© Nghi√™m-Ph√≥ Tr∆∞·ªüng ph√≤ng" }, "nguyenthugiang": { pass: "123456", name: "Nguy·ªÖn Thu Giang-Ph√≥ Tr∆∞·ªüng ph√≤ng" }, "phamthithuhanh": { pass: "123456", name: "Ph·∫°m Thi Thu H·∫°nh-Ph√≥ Tr∆∞·ªüng ph√≤ng" } };

        let APP_DATA = []; let currentEditNodeId = null; let loggedInUser = null; let expandedAdminNodes = new Set(); let isFirstLoadAdmin = true; let expandedUserMenuNodes = new Set(); let lastSearchKeyword = "";
        const thongKeRef = db.collection("sotay").doc("thongke");

        function getLocalTodayString() { return new Date(new Date().getTime() - (new Date().getTimezoneOffset() * 60000)).toISOString().split('T')[0]; }

        function fetchAndRenderDashboard() {
            thongKeRef.get().then((doc) => { if (doc.exists) renderDashboard(doc.data()); else renderDashboard({ totalVisits: 0, searchCount: 0, dailyVisits: {} }); }).catch(err => console.log(err));
        } setInterval(fetchAndRenderDashboard, 3600000);

        function recordVisit() {
            if (!sessionStorage.getItem('visited_sotay')) {
                let today = getLocalTodayString();
                thongKeRef.set({ totalVisits: firebase.firestore.FieldValue.increment(1), dailyVisits: { [today]: firebase.firestore.FieldValue.increment(1) } }, { merge: true }).then(fetchAndRenderDashboard);
                sessionStorage.setItem('visited_sotay', 'true');
            } else { fetchAndRenderDashboard(); }
        } recordVisit();

        function renderDashboard(data) {
            let total = data.totalVisits || 0; let search = data.searchCount || 0; let daily = data.dailyVisits || {};
            let todayDate = new Date(); let last7Days = []; let sum7Days = 0; let maxDaily = 0;
            for (let i = 6; i >= 0; i--) {
                let d = new Date(todayDate.getTime()); d.setDate(d.getDate() - i);
                let local = new Date(d.getTime() - (d.getTimezoneOffset() * 60000));
                let dateStr = local.toISOString().split('T')[0]; let displayStr = local.getDate() + '/' + (local.getMonth()+1);
                let visits = daily[dateStr] || data[`dailyVisits.${dateStr}`] || 0; 
                sum7Days += visits; if (visits > maxDaily) maxDaily = visits; last7Days.push({ date: displayStr, visits: visits });
            }
            let todayVisits = last7Days[6].visits; let chartHtml = '<div class="chart-container">';
            last7Days.forEach(day => { let h = maxDaily > 0 ? (day.visits / maxDaily * 100) : 0; if(h < 5 && day.visits > 0) h = 5; chartHtml += `<div class="chart-bar" style="height:${h}%;"><span class="chart-tooltip">${day.date}: ${day.visits} l∆∞·ª£t</span></div>`; });
            chartHtml += `</div><div class="chart-labels"><span>${last7Days[0].date}</span><span>H√¥m nay</span></div>`;
            document.getElementById('miniDashboard').innerHTML = `<div class="stat-row"><span>üëÅ T·ªïng truy c·∫≠p:</span> <b>${total}</b></div><div class="stat-row"><span>üìÖ H√¥m nay:</span> <b>${todayVisits}</b></div><div class="stat-row"><span>üìà 7 ng√†y qua:</span> <b>${sum7Days}</b></div><div class="stat-row"><span>üîç L∆∞·ª£t t√¨m ki·∫øm:</span> <b>${search}</b></div> ${chartHtml}`;
        }

        db.collection("sotay").doc("dulieu").onSnapshot((doc) => {
            if (doc.exists) { APP_DATA = doc.data().treeData || []; } else { APP_DATA = [{ id: 'r1', title: 'PH·∫¶N 1', tag: '', summary: '', detail: '', level: 0, children: [] }]; }
            if (isFirstLoadAdmin && APP_DATA.length > 0) { APP_DATA.forEach(node => { expandedAdminNodes.add(node.id); expandedUserMenuNodes.add(node.id); }); isFirstLoadAdmin = false; }
            renderUserInterface(); renderRecentViews();
            if (document.getElementById('adminPanel').style.display === 'block') { renderAdminTree(); }
        });

        function highlightText(text, keyword) {
            if (!keyword || !text) return text || '';
            let safeKeyword = keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const regex = new RegExp(`(${safeKeyword})(?![^<]*>)`, 'gi');
            return text.replace(regex, '<mark class="search-highlight">$1</mark>');
        }

        function renderUserInterface() {
            renderSidebarMenu(); 
            const contentEl = document.getElementById('dynamicContent'); contentEl.innerHTML = ''; 
            if (!APP_DATA || APP_DATA.length === 0) return;
            
            function processNode(items, container) {
                items.forEach(item => {
                    let div = document.createElement('div'); div.id = item.id; let innerContent = '';
                    let downloadBtn = item.fileUrl ? `<a href="${item.fileUrl}" target="_blank" class="inline-download" title="${item.fileName || 'T·∫£i bi·ªÉu m·∫´u'}" onclick="event.stopPropagation()">üì• T·∫£i m·∫´u</a>` : ''; 
                    let nextContainer = container; 
                    
                    let displayTitle = highlightText(item.title || 'Ch∆∞a ƒë·∫∑t t√™n', lastSearchKeyword);
                    
                    let safeSummary = processLegacyText(item.summary);
                    let displaySummary = highlightText(safeSummary, lastSearchKeyword);

                    if(item.level === 0 || item.level === 1) {
                        let hTag = item.level === 0 ? 'h2' : 'h3'; let hClass = item.level === 0 ? 'phan-header' : 'muc-header';
                        innerContent += `<${hTag} class="${hClass}">${displayTitle} ${downloadBtn}</${hTag}>`;
                        if (item.summary) innerContent += `<div class="content-text" style="border:none; padding-left:0;">${displaySummary}</div>`;
                        if (item.detail) innerContent += `<div class="step-actions"><div class="btn-trich-dan" onclick="showPopup('${item.id}')">üìñ Xem quy ƒë·ªãnh chi ti·∫øt</div></div>`;
                        div.innerHTML = innerContent; container.appendChild(div);
                    } else {
                        let levelClass = item.level === 2 ? 'level-2' : (item.level === 3 ? 'level-3' : 'level-4');
                        let titleHtml = '';
                        if (item.level === 2) titleHtml = `<div style="font-weight: 700; font-size: 1.15em; color: #2980b9; margin-bottom: 0;">${displayTitle} ${downloadBtn}</div>`;
                        else if (item.level === 3) titleHtml = `<div style="font-weight: 700; font-size: 1.05em; color: #27ae60; margin-bottom: 0;">${displayTitle} ${downloadBtn}</div>`;
                        else titleHtml = `<div class="step-number" style="margin-bottom:0">${displayTitle} ${downloadBtn}</div>`;

                        div.className = `step-box ${levelClass}`; 
                        let tagHtml = item.tag ? `<span class="tag-label">${highlightText(item.tag, lastSearchKeyword)}</span>` : ''; 
                        let summaryHtml = item.summary ? `<div class="content-text">${displaySummary}</div>` : '';
                        let detailBtn = item.detail ? `<div class="step-actions" style="margin: 0 10px 15px 15px;"><div class="btn-trich-dan" onclick="showPopup('${item.id}')">üìñ Xem chi ti·∫øt</div></div>` : '';
                        let hasChildren = item.children && item.children.length > 0; 
                        let iconHtml = hasChildren ? `<div class="step-icon">‚ñº</div>` : '';
                        
                        div.innerHTML = `<div class="step-header" onclick="toggleStep(this, event, '${item.id}', '${item.title ? item.title.replace(/'/g, "\\'") : ''}')"><div class="step-title-wrapper">${tagHtml}${titleHtml}</div>${iconHtml}</div><div class="step-body-wrapper"><div class="step-body"><div class="step-body-inner" id="inner-${item.id}">${summaryHtml}${detailBtn}</div></div></div>`;
                        container.appendChild(div); nextContainer = div.querySelector(`#inner-${item.id}`);
                    }
                    if(item.children && item.children.length > 0) processNode(item.children, nextContainer);
                });
            } processNode(APP_DATA, contentEl);
        }

        function highlightSidebarMenu(id) {
            document.querySelectorAll('.menu-link').forEach(el => el.classList.remove('active-menu'));
            let target = document.querySelector(`.menu-link[data-id="${id}"]`);
            if(target) { target.classList.add('active-menu'); target.scrollIntoView({ behavior: 'smooth', block: 'center' }); }
        }

        function updateBreadcrumb(targetId) {
            let pathIds = getParentIdPath(targetId, APP_DATA);
            if (!pathIds || pathIds.length === 0) return;
            let html = 'üìç ';
            pathIds.forEach((pid, index) => {
                let node = findNode(pid, APP_DATA);
                if(node) {
                    html += `<span onclick="jumpToResult('${pid}')">${node.title}</span>`;
                    if(index < pathIds.length - 1) html += ' <span style="color:#999; text-decoration:none; cursor:default"> &gt; </span> ';
                }
            });
            const bar = document.getElementById('breadcrumbBar');
            bar.innerHTML = html; bar.style.display = 'block';
        }

        function toggleStep(headerEl, event, id, title) {
            if (event && (event.target.closest('a') || event.target.closest('.btn-trich-dan'))) return; 
            if (event) event.stopPropagation();
            const stepBox = headerEl.parentElement; let parentInner = stepBox.parentElement;
            if (parentInner) { 
                let siblings = parentInner.children; 
                for(let i=0; i<siblings.length; i++) { 
                    if (siblings[i] !== stepBox && siblings[i].classList.contains('step-box')) siblings[i].classList.remove('active'); 
                } 
            }
            stepBox.classList.toggle('active');
            if(stepBox.classList.contains('active')) {
                updateBreadcrumb(id);
                highlightSidebarMenu(id);
                if(title) addRecentView(id, title);
            }
        }

        function expandAll() { document.querySelectorAll('.step-box').forEach(box => box.classList.add('active')); }
        function collapseAll() { document.querySelectorAll('.step-box').forEach(box => box.classList.remove('active')); document.getElementById('breadcrumbBar').style.display = 'none'; topFunction(); }

        function renderSidebarMenu() {
            const menuEl = document.getElementById('menuList'); menuEl.innerHTML = '';
            function buildUserMenuHtml(nodes) {
                let html = '<ul>';
                nodes.forEach(item => {
                    if (item.level > 3) return; 
                    let hasValidChildren = item.children && item.children.some(c => c.level <= 3); let isExpanded = expandedUserMenuNodes.has(item.id);
                    let icon = item.level === 0 ? 'üìö' : (item.level === 1 ? 'üìÇ' : (item.level === 2 ? 'üìÑ' : 'üîπ'));
                    let toggleBtn = hasValidChildren ? `<span class="menu-toggle" onclick="toggleUserMenuNode(event, '${item.id}')">${isExpanded ? '‚ñº' : '‚ñ∂'}</span>` : `<span style="display:inline-block;width:20px;"></span>`;
                    html += `<li><div class="menu-item-row">${toggleBtn}<span style="margin-right: 5px; font-size:0.85rem">${icon}</span><a class="menu-link" data-id="${item.id}" onclick="toggleMenu(false); jumpToResult('${item.id}')">${item.title || 'M·ª•c ch∆∞a c√≥ t√™n'}</a></div>`;
                    if (hasValidChildren) { html += `<div style="display: ${isExpanded ? 'block' : 'none'};">${buildUserMenuHtml(item.children)}</div>`; } html += `</li>`;
                }); html += '</ul>'; return html;
            } menuEl.innerHTML = buildUserMenuHtml(APP_DATA);
        }

        function toggleUserMenuNode(event, id) { event.stopPropagation(); if (expandedUserMenuNodes.has(id)) expandedUserMenuNodes.delete(id); else expandedUserMenuNodes.add(id); renderSidebarMenu(); }

        function openSearchModal() { document.getElementById('modalSearch').style.display = 'flex'; document.getElementById('searchInput').value = ''; document.getElementById('faqSuggestions').style.display = 'block'; document.getElementById('searchResults').innerHTML = '<div class="no-result">G√µ t·ª´ kh√≥a ƒë·ªÉ t√¨m...</div>'; setTimeout(()=>document.getElementById('searchInput').focus(), 100); }
        function closeSearchModal() { document.getElementById('modalSearch').style.display = 'none'; }
        function quickAsk(keyword) { document.getElementById('searchInput').value = keyword; document.getElementById('searchTagFilter').value = ''; performSearch(); }
        function removeAccents(str) { return str ? str.normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase() : ""; }
        
        function performSearch() {
            let kwRaw = document.getElementById('searchInput').value.trim(); let kwNoAccent = removeAccents(kwRaw); 
            let filterTag = document.getElementById('searchTagFilter').value.toLowerCase();
            let resContainer = document.getElementById('searchResults'); let faqDiv = document.getElementById('faqSuggestions');
            
            if (kwNoAccent.length < 2 && filterTag === '') { resContainer.innerHTML = '<div class="no-result">Vui l√≤ng g√µ √≠t nh·∫•t 2 k√Ω t·ª± ho·∫∑c ch·ªçn b·ªô l·ªçc.</div>'; faqDiv.style.display = 'block'; return; } 
            
            faqDiv.style.display = 'none'; lastSearchKeyword = kwRaw; let results = [];
            
            function traverse(nodes, parentPath) {
                for(let n of nodes) {
                    let curPath = parentPath ? (parentPath + " > " + n.title) : (n.title || '');
                    let tagText = n.tag ? n.tag.toLowerCase() : '';
                    let isTagMatch = filterTag === '' || tagText.includes(filterTag);
                    let isKwMatch = kwNoAccent === '' || removeAccents((n.title||'')+" "+(n.tag||'')+" "+(n.summary||'')+" "+(n.detail||'')).includes(kwNoAccent);
                    
                    if (isTagMatch && isKwMatch) { 
                        results.push({ id: n.id, path: parentPath || 'M·ª•c ch√≠nh', title: highlightText(n.title, kwRaw), snippet: n.tag ? `[${n.tag}] Nh·∫•n xem chi ti·∫øt...` : "Nh·∫•n ƒë·ªÉ xem k·∫øt qu·∫£ kh·ªõp..." }); 
                    }
                    if (n.children) traverse(n.children, curPath);
                }
            } traverse(APP_DATA, "");
            
            thongKeRef.set({ searchCount: firebase.firestore.FieldValue.increment(1) }, { merge: true });
            if (results.length === 0) resContainer.innerHTML = '<div class="no-result">‚ùå Kh√¥ng t√¨m th·∫•y.</div>';
            else { 
                let html = `<div style="font-size:0.9rem; color:var(--text-muted); margin-bottom:10px;">T√¨m th·∫•y ${results.length} k·∫øt qu·∫£</div>`; 
                results.forEach(r => html += `<div class="result-item" onclick="jumpToResult('${r.id}')"><div class="result-path">üìÇ ${r.path}</div><div class="result-title">${r.title}</div><div class="result-snippet">${r.snippet}</div></div>`); 
                resContainer.innerHTML = html; 
            }
            renderUserInterface();
        }
        document.getElementById('searchInput').addEventListener('keypress', e => { if (e.key === 'Enter') performSearch(); });
        document.getElementById('searchTagFilter').addEventListener('change', performSearch);
        
        function jumpToResult(id) {
            closeSearchModal(); let el = document.getElementById(id);
            if (el) {
                let parentNode = el.parentElement; 
                while (parentNode && parentNode.id !== 'dynamicContent') { if (parentNode.classList.contains('step-box')) parentNode.classList.add('active'); parentNode = parentNode.parentElement; }
                if (el.classList.contains('step-box')) el.classList.add('active');
                
                let nodeToOpen = findNode(id, APP_DATA); 
                if(nodeToOpen) { 
                    let parentIdPath = getParentIdPath(id, APP_DATA); parentIdPath.forEach(pid => expandedUserMenuNodes.add(pid)); 
                    renderSidebarMenu(); updateBreadcrumb(id); highlightSidebarMenu(id); addRecentView(nodeToOpen.id, nodeToOpen.title);
                }
                setTimeout(() => { 
                    window.scrollTo({ top: el.getBoundingClientRect().top + window.pageYOffset - 100, behavior: "smooth" });
                    let oBg = el.style.backgroundColor; el.style.backgroundColor = "rgba(241, 196, 15, 0.2)"; setTimeout(() => el.style.backgroundColor = oBg || '', 2000); 
                }, 150);
            }
        }

        function getParentIdPath(targetId, nodes, path = []) { for(let node of nodes) { if(node.id === targetId) return [...path, node.id]; if(node.children) { let foundPath = getParentIdPath(targetId, node.children, [...path, node.id]); if(foundPath) return foundPath; } } return null; }
        function findNode(id, nodes) { for(let node of nodes) { if(node.id === id) return node; if(node.children) { let f = findNode(id, node.children); if(f) return f; } } return null; }

        function toggleMenu(f) { const sb = document.getElementById('sidebar'); const ov = document.querySelector('.overlay'); if (typeof f !== 'undefined') { if(f) { sb.classList.add('active'); ov.classList.add('active'); } else { sb.classList.remove('active'); ov.classList.remove('active'); } } else { sb.classList.toggle('active'); ov.classList.toggle('active'); } }
        
        function showPopup(id) { 
            let nodeData = findNode(id, APP_DATA);
            if(nodeData && nodeData.detail) {
                let safeDetail = processLegacyText(nodeData.detail);
                document.getElementById('noi-dung-chi-tiet').innerHTML = highlightText(safeDetail, lastSearchKeyword); 
                document.getElementById('modalTrichDan').style.display = 'flex'; 
                updateBreadcrumb(id); addRecentView(id, nodeData.title); highlightSidebarMenu(id);
            }
        }
        
        function closePopup(id) { document.getElementById(id).style.display = 'none'; }
        function closeModalOnBgClick(e, id) { if(e.target.id === id) closePopup(id); }
        function topFunction() { window.scrollTo({top: 0, behavior: 'smooth'}); }

        let draggedNodeId = null;

        function saveTreeToFirebase(newTree) { db.collection("sotay").doc("dulieu").update({ treeData: newTree }).catch(err => alert("L·ªói khi l∆∞u c·∫•u tr√∫c: " + err)); }
        
        function confirmUnsaved() { if (hasUnsavedChanges) return confirm("‚ö†Ô∏è B·∫°n c√≥ thay ƒë·ªïi ch∆∞a l∆∞u! X√°c nh·∫≠n r·ªùi ƒëi v√† HU·ª∂ B·ªé nh·ªØng thay ƒë·ªïi v·ª´a nh·∫≠p?"); return true; }

        function moveNodeUp(e, id) { e.stopPropagation(); if(!confirmUnsaved()) return; let serverTree = JSON.parse(JSON.stringify(APP_DATA)); function process(nodes) { for(let i=0; i<nodes.length; i++) { if(nodes[i].id === id) { if(i > 0) { let temp = nodes[i]; nodes[i] = nodes[i-1]; nodes[i-1] = temp; return true; } return true; } if(nodes[i].children && process(nodes[i].children)) return true; } return false; } if(process(serverTree)) saveTreeToFirebase(serverTree); }
        function moveNodeDown(e, id) { e.stopPropagation(); if(!confirmUnsaved()) return; let serverTree = JSON.parse(JSON.stringify(APP_DATA)); function process(nodes) { for(let i=0; i<nodes.length; i++) { if(nodes[i].id === id) { if(i < nodes.length - 1) { let temp = nodes[i]; nodes[i] = nodes[i+1]; nodes[i+1] = temp; return true; } return true; } if(nodes[i].children && process(nodes[i].children)) return true; } return false; } if(process(serverTree)) saveTreeToFirebase(serverTree); }

        function handleDragStart(e, id) { draggedNodeId = id; e.dataTransfer.effectAllowed = 'move'; e.currentTarget.classList.add('dragging'); }
        function handleDragEnd(e) { e.currentTarget.classList.remove('dragging'); }
        function handleDragOver(e, id) { e.preventDefault(); e.stopPropagation(); if(id === draggedNodeId) return; e.currentTarget.classList.add('drag-over'); }
        function handleDragLeave(e) { e.currentTarget.classList.remove('drag-over'); }
        function handleDrop(e, targetId) {
            e.preventDefault(); e.stopPropagation(); e.currentTarget.classList.remove('drag-over');
            if(!draggedNodeId || draggedNodeId === targetId) return; if(!confirmUnsaved()) return;
            if (isDescendant(draggedNodeId, targetId, APP_DATA)) { alert("‚õî L·ªói: Kh√¥ng th·ªÉ k√©o th∆∞ m·ª•c Cha th·∫£ v√†o b√™n trong C·∫•p Con c·ªßa n√≥!"); return; }
            let serverTree = JSON.parse(JSON.stringify(APP_DATA)); let nodeToMove = null;
            function removeNode(nodes) { for (let i = 0; i < nodes.length; i++) { if (nodes[i].id === draggedNodeId) { nodeToMove = nodes.splice(i, 1)[0]; return true; } if (nodes[i].children && removeNode(nodes[i].children)) return true; } return false; }
            removeNode(serverTree); if(!nodeToMove) return;
            function addNodeToParent(nodes) { for (let i = 0; i < nodes.length; i++) { if (nodes[i].id === targetId) { if (!nodes[i].children) nodes[i].children = []; nodes[i].children.push(nodeToMove); updateLevels(nodeToMove, nodes[i].level + 1); return true; } if (nodes[i].children && addNodeToParent(nodes[i].children)) return true; } return false; }
            function updateLevels(node, newLevel) { node.level = newLevel; if (node.children) node.children.forEach(c => updateLevels(c, newLevel + 1)); }
            addNodeToParent(serverTree); expandedAdminNodes.add(targetId); saveTreeToFirebase(serverTree);
        }
        function isDescendant(parentId, childId, nodes) { let parentNode = findNode(parentId, nodes); if (!parentNode || !parentNode.children) return false; function check(children) { for (let c of children) { if (c.id === childId) return true; if (c.children && check(c.children)) return true; } return false; } return check(parentNode.children); }

        function saveCurrentNodeToServer() {
            if (!currentEditNodeId) return; const btn = document.getElementById('btnSaveSingle'); btn.innerText = "‚è≥ ƒêang l∆∞u..."; btn.disabled = true;
            let sumVal = quillSummary.root.innerHTML; if(sumVal === '<p><br></p>') sumVal = '';
            let detVal = quillDetail.root.innerHTML; if(detVal === '<p><br></p>') detVal = '';
            let updatedData = { tag: document.getElementById('inpTag').value, title: document.getElementById('inpTitle').value, summary: sumVal, detail: detVal, fileUrl: document.getElementById('inpFileUrl').value, fileName: document.getElementById('inpFileName').value };

            const docRef = db.collection("sotay").doc("dulieu");
            db.runTransaction((transaction) => {
                return transaction.get(docRef).then((doc) => {
                    let serverTree = doc.data().treeData || []; let isFound = false;
                    function updateNode(nodes) { for(let i=0; i<nodes.length; i++) { if(nodes[i].id === currentEditNodeId) { nodes[i] = { ...nodes[i], ...updatedData }; isFound = true; return; } if(nodes[i].children) updateNode(nodes[i].children); } } updateNode(serverTree);
                    if (isFound) { transaction.update(docRef, { treeData: serverTree }); } else { throw "M·ª•c n√†y c√≥ th·ªÉ ƒë√£ b·ªã x√≥a!"; }
                });
            }).then(() => { btn.disabled = false; resetSaveButton(); }).catch((err) => { btn.disabled = false; resetSaveButton(); alert("L·ªói ƒë·ªìng b·ªô: " + err); });
        }

        function addNewRoot() { if(!confirmUnsaved()) return; let newNode = {id: 'r'+Date.now(), title:'PH·∫¶N M·ªöI T·∫†O', tag:'', summary:'', detail:'', level:0, children:[]}; const docRef = db.collection("sotay").doc("dulieu"); db.runTransaction((transaction) => { return transaction.get(docRef).then((doc) => { let serverTree = doc.data().treeData || []; serverTree.push(newNode); transaction.update(docRef, { treeData: serverTree }); }); }).then(() => { selectItem(newNode.id); }); }
        function addSubItem() { if(!confirmUnsaved()) return; if(!currentEditNodeId) return; let parentNode = findNode(currentEditNodeId, APP_DATA); if(!parentNode) return; let newNode = {id: 'n'+Date.now(), title:'M·ª•c con m·ªõi', tag:'', summary:'', detail:'', level: parentNode.level + 1, children:[]}; expandedAdminNodes.add(currentEditNodeId); const docRef = db.collection("sotay").doc("dulieu"); db.runTransaction((transaction) => { return transaction.get(docRef).then((doc) => { let serverTree = doc.data().treeData || []; function appendChild(nodes) { for(let i=0; i<nodes.length; i++) { if(nodes[i].id === currentEditNodeId) { if(!nodes[i].children) nodes[i].children = []; nodes[i].children.push(newNode); return true; } if(nodes[i].children && appendChild(nodes[i].children)) return true; } return false; } appendChild(serverTree); transaction.update(docRef, { treeData: serverTree }); }); }).then(() => { selectItem(newNode.id); }); }
        function deleteCurrentItem() { if(!currentEditNodeId || !confirm('C·∫¢NH B√ÅO: B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën X√ìA m·ª•c n√†y? To√†n b·ªô m·ª•c con b√™n trong c≈©ng s·∫Ω b·ªã x√≥a vƒ©nh vi·ªÖn!')) return; const docRef = db.collection("sotay").doc("dulieu"); db.runTransaction((transaction) => { return transaction.get(docRef).then((doc) => { let serverTree = doc.data().treeData || []; function removeNode(nodes) { let idx = nodes.findIndex(c => c.id === currentEditNodeId); if(idx > -1) { nodes.splice(idx, 1); return true; } for(let i=0; i<nodes.length; i++){ if(nodes[i].children && removeNode(nodes[i].children)) return true; } return false; } removeNode(serverTree); transaction.update(docRef, { treeData: serverTree }); }); }).then(() => { currentEditNodeId = null; hasUnsavedChanges = false; document.getElementById('editorArea').style.display='none'; document.getElementById('editorPlaceholder').style.display='block'; }); }

        function toggleAdminNode(event, id) { event.stopPropagation(); if (expandedAdminNodes.has(id)) expandedAdminNodes.delete(id); else expandedAdminNodes.add(id); renderAdminTree(); }

        function filterAdminTree() {
            let kw = removeAccents(document.getElementById('adminSearchInput').value.toLowerCase());
            let nodes = document.querySelectorAll('#adminTree .tree-node');
            if(!kw) { nodes.forEach(n => n.style.display = 'block'); return; }
            nodes.forEach(n => {
                let text = removeAccents(n.innerText.toLowerCase());
                if(text.includes(kw)) {
                    n.style.display = 'block';
                    let parent = n.parentElement;
                    while(parent && parent.id !== 'adminTree') {
                        if(parent.classList.contains('tree-children')) {
                            parent.classList.remove('collapsed');
                            parent.parentElement.style.display = 'block'; 
                        }
                        parent = parent.parentElement;
                    }
                } else { n.style.display = 'none'; }
            });
        }

        function renderAdminTree() {
            const tree = document.getElementById('adminTree'); tree.innerHTML = '';
            function buildHtml(nodes) {
                let html = '';
                nodes.forEach(node => {
                    let active = (currentEditNodeId === node.id) ? 'active' : ''; let icon = node.level === 0 ? 'üìö' : (node.level === 1 ? 'üìÇ' : (node.level === 2 ? 'üìÑ' : (node.level === 3 ? 'üìë' : 'üìù'))); let extraClass = node.level === 0 ? 'root-item' : 'sub-item'; let hasChildren = node.children && node.children.length > 0; let isExpanded = expandedAdminNodes.has(node.id); let toggleBtn = hasChildren ? `<span class="tree-toggle" onclick="toggleAdminNode(event, '${node.id}')">${isExpanded ? '‚ñº' : '‚ñ∂'}</span>` : `<span style="display:inline-block;width:24px;"></span>`;
                    let btnUpDown = `<div style="margin-left:auto;"><button class="btn-order" onclick="moveNodeUp(event, '${node.id}')" title="ƒê·∫©y l√™n">‚ñ≤</button><button class="btn-order" onclick="moveNodeDown(event, '${node.id}')" title="ƒê·∫©y xu·ªëng">‚ñº</button></div>`;
                    html += `<div class="tree-node" id="node-${node.id}"><div class="tree-item ${extraClass} ${active}" draggable="true" ondragstart="handleDragStart(event, '${node.id}')" ondragend="handleDragEnd(event)" ondragover="handleDragOver(event, '${node.id}')" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event, '${node.id}')" onclick="selectItem('${node.id}')">${toggleBtn}<span style="margin-right: 5px;">${icon}</span><span style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${node.title || 'Ch∆∞a ƒë·∫∑t t√™n'}</span>${btnUpDown}</div>`;
                    if(hasChildren) { html += `<div class="tree-children ${isExpanded ? '' : 'collapsed'}">${buildHtml(node.children)}</div>`; } html += `</div>`;
                }); return html;
            } tree.innerHTML = buildHtml(APP_DATA); filterAdminTree();
        }

        function selectItem(id) {
            if (hasUnsavedChanges && currentEditNodeId !== id) { if (!confirm("‚ö†Ô∏è C·∫¢NH B√ÅO: B·∫°n ƒëang nh·∫≠p n·ªôi dung nh∆∞ng CH∆ØA L∆ØU!\n\nB·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën b·ªè qua v√† chuy·ªÉn sang m·ª•c kh√°c kh√¥ng? (N·ªôi dung v·ª´a nh·∫≠p s·∫Ω b·ªã m·∫•t)")) { return; } }
            resetSaveButton(); currentEditNodeId = id; 
            let nodeData = findNode(id, APP_DATA); if(!nodeData) return; 
            renderAdminTree(); 
            
            document.getElementById('editorPlaceholder').style.display = 'none'; document.getElementById('editorArea').style.display = 'block'; 
            isSystemChangingContent = true;
            document.getElementById('inpTag').value = nodeData.tag || ''; document.getElementById('inpTitle').value = nodeData.title || ''; 
            document.getElementById('inpFileUrl').value = nodeData.fileUrl || ''; document.getElementById('inpFileName').value = nodeData.fileName || '';
            
            quillSummary.root.innerHTML = processLegacyText(nodeData.summary || ''); 
            quillDetail.root.innerHTML = processLegacyText(nodeData.detail || '');
            
            setTimeout(() => { isSystemChangingContent = false; }, 100);
        }

        function processLogin() { let user = document.getElementById('username').value.trim().toLowerCase(); let pass = document.getElementById('password').value; let errBox = document.getElementById('loginError'); if (ADMIN_ACCOUNTS[user] && ADMIN_ACCOUNTS[user].pass === pass) { loggedInUser = user; document.getElementById('loginOverlay').style.display = 'none'; document.getElementById('adminPanel').style.display = 'block'; document.getElementById('adminWelcome').innerHTML = `ƒêang ƒëƒÉng nh·∫≠p b·ªüi: <b>${ADMIN_ACCOUNTS[user].name}</b>`; renderAdminTree(); } else { errBox.style.display = 'block'; document.getElementById('password').value = ''; } }
        function openLoginForm() { toggleMenu(false); document.getElementById('loginOverlay').style.display = 'flex'; }
        function closeLoginForm() { document.getElementById('loginOverlay').style.display = 'none'; }
        function closeAdminPanel() { if(!confirmUnsaved()) return; document.getElementById('adminPanel').style.display = 'none'; loggedInUser = null; }

    </script>
</body>
</html>